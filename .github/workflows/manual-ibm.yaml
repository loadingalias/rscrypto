name: IBM

on:
  workflow_dispatch:
    inputs:
      run_ci_s390x:
        description: "Run CI on IBM Z (s390x)"
        required: false
        type: boolean
        default: false
      run_ci_power10:
        description: "Run CI on IBM POWER10 (ppc64le)"
        required: false
        type: boolean
        default: false
      run_bench_s390x:
        description: "Run benchmarks on IBM Z (s390x)"
        required: false
        type: boolean
        default: false
      run_bench_power10:
        description: "Run benchmarks on IBM POWER10 (ppc64le)"
        required: false
        type: boolean
        default: false
      bench_crates:
        description: "Benchmark crates (comma-separated, empty = workspace)"
        required: false
        type: string
        default: ""
      bench_benches:
        description: "Specific benches (comma-separated, optional)"
        required: false
        type: string
        default: ""
      bench_only:
        description: "Algorithm selector(s), comma-separated (recommended: checksum,blake3)"
        required: false
        type: string
        default: "checksum,blake3"
      bench_filter:
        description: "Raw Criterion filter token(s), comma-separated (advanced)"
        required: false
        type: string
        default: ""
      bench_quick:
        description: "Quick benchmark mode (Criterion --quick + shorter defaults)"
        required: false
        type: boolean
        default: true
      bench_warmup_ms:
        description: "Warmup duration override in ms (optional)"
        required: false
        type: string
        default: ""
      bench_measure_ms:
        description: "Measurement duration override in ms (optional)"
        required: false
        type: string
        default: ""
      bench_sample_size:
        description: "Criterion sample size override (optional, >=10)"
        required: false
        type: string
        default: ""
      bench_profile_time_secs:
        description: "Criterion profile-time override in seconds (optional)"
        required: false
        type: string
        default: ""
      bench_allow_full_run:
        description: "Allow unfiltered full benchmark runs on IBM (expensive)"
        required: false
        type: boolean
        default: false
      run_tune_s390x:
        description: "Run tune on IBM Z (s390x)"
        required: false
        type: boolean
        default: false
      run_tune_power10:
        description: "Run tune on IBM POWER10 (ppc64le)"
        required: false
        type: boolean
        default: false
      tune_crates:
        description: "Tune crates (comma-separated)"
        required: false
        type: string
        default: "checksum,hashes"
      tune_only:
        description: "Algorithm selector(s), comma-separated (recommended: checksum,blake3)"
        required: false
        type: string
        default: "checksum,blake3"
      tune_quick:
        description: "Quick developer preview only (faster, noisier; never for dispatch apply)"
        required: false
        type: boolean
        default: false
      tune_apply:
        description: "Apply tuning output into dispatch tables and emit patch artifact"
        required: false
        type: boolean
        default: false
      tune_warmup_ms:
        description: "Global warmup duration override in ms (optional)"
        required: false
        type: string
        default: ""
      tune_measure_ms:
        description: "Global measurement duration override in ms (optional)"
        required: false
        type: string
        default: ""
      tune_checksum_warmup_ms:
        description: "Checksum-only warmup override in ms (optional)"
        required: false
        type: string
        default: ""
      tune_checksum_measure_ms:
        description: "Checksum-only measurement override in ms (optional)"
        required: false
        type: string
        default: ""
      tune_hash_warmup_ms:
        description: "Hash-only warmup override in ms (optional)"
        required: false
        type: string
        default: ""
      tune_hash_measure_ms:
        description: "Hash-only measurement override in ms (optional)"
        required: false
        type: string
        default: ""
      tune_repeats:
        description: "Measurement repeats per platform lane (default: 1)"
        required: false
        type: string
        default: ""
      tune_aggregation:
        description: "Repeated-run aggregation mode (auto, median, trimmed-mean)"
        required: false
        type: string
        default: "auto"
      tune_allow_full_run:
        description: "Allow unfiltered full tune runs on IBM (expensive)"
        required: false
        type: boolean
        default: false

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RSCRYPTO_BENCH_MODE: ci
  RSCRYPTO_TUNE_MODE: ci

concurrency:
  group: manual-ibm-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lane-contract:
    name: Lane Contract (manual-ibm)
    runs-on: ubuntu-latest
    steps:
      - name: Assert lane
        run: |
          test "${{ github.event_name }}" = "workflow_dispatch"
          echo "lane=manual-ibm"

  ci-s390x:
    if: inputs.run_ci_s390x
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-s390x
      timeout_minutes: 90
      setup_kind: default
      cache_key: manual-ibm-ci-s390x
      tools_mode: ibm
      toolchain_components: "clippy, rustfmt"
      pre_script: |
        uname -a
        lscpu
        cat /proc/cpuinfo | head -50
      run_script: |
        just ci-check
        just test --all

  ci-power10:
    if: inputs.run_ci_power10
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-ppc64le-p10
      timeout_minutes: 90
      setup_kind: default
      cache_key: manual-ibm-ci-power10
      tools_mode: ibm
      toolchain_components: "clippy, rustfmt"
      pre_script: |
        uname -a
        lscpu
        cat /proc/cpuinfo | head -50
      run_script: |
        just ci-check
        just test --all

  bench-s390x:
    if: inputs.run_bench_s390x
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-s390x
      timeout_minutes: 120
      setup_kind: default
      cache_key: manual-ibm-bench-s390x
      tools_mode: none
      toolchain_components: ""
      pre_script: |
        uname -a
        lscpu
        cat /proc/cpuinfo | head -50
      run_script: |
        if [[ "${{ inputs.bench_allow_full_run && 'true' || 'false' }}" != "true" ]] \
          && [[ -z "${{ inputs.bench_only }}" ]] \
          && [[ -z "${{ inputs.bench_filter }}" ]]; then
          echo "error: IBM bench requires targeted input. Set bench_only (recommended) or bench_filter, or set bench_allow_full_run=true."
          exit 2
        fi
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.bench_crates }}" \
        BENCH_BENCHES="${{ inputs.bench_benches }}" \
        BENCH_ONLY="${{ inputs.bench_only }}" \
        BENCH_FILTER="${{ inputs.bench_filter }}" \
        BENCH_QUICK=${{ inputs.bench_quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.bench_warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.bench_measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.bench_sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.bench_profile_time_secs }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-ibm-s390x
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-power10:
    if: inputs.run_bench_power10
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-ppc64le-p10
      timeout_minutes: 120
      setup_kind: default
      cache_key: manual-ibm-bench-power10
      tools_mode: none
      toolchain_components: ""
      pre_script: |
        uname -a
        lscpu
        cat /proc/cpuinfo | head -50
      run_script: |
        if [[ "${{ inputs.bench_allow_full_run && 'true' || 'false' }}" != "true" ]] \
          && [[ -z "${{ inputs.bench_only }}" ]] \
          && [[ -z "${{ inputs.bench_filter }}" ]]; then
          echo "error: IBM bench requires targeted input. Set bench_only (recommended) or bench_filter, or set bench_allow_full_run=true."
          exit 2
        fi
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.bench_crates }}" \
        BENCH_BENCHES="${{ inputs.bench_benches }}" \
        BENCH_ONLY="${{ inputs.bench_only }}" \
        BENCH_FILTER="${{ inputs.bench_filter }}" \
        BENCH_QUICK=${{ inputs.bench_quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.bench_warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.bench_measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.bench_sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.bench_profile_time_secs }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-ibm-power10
      artifact_path: |
        benchmark-results/
        target/criterion/

  tune-s390x:
    if: inputs.run_tune_s390x
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-s390x
      timeout_minutes: 120
      setup_kind: default
      cache_key: manual-ibm-tune-s390x
      tools_mode: none
      toolchain_components: ""
      pre_script: |
        uname -a
        lscpu
      run_script: |
        if [[ "${{ inputs.tune_allow_full_run && 'true' || 'false' }}" != "true" ]] \
          && [[ -z "${{ inputs.tune_only }}" ]]; then
          echo "error: IBM tune requires targeted input. Set tune_only (recommended) or set tune_allow_full_run=true."
          exit 2
        fi
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.tune_quick && 'true' || 'false' }} \
        TUNE_CRATES="${{ inputs.tune_crates }}" \
        TUNE_ONLY="${{ inputs.tune_only }}" \
        TUNE_APPLY=${{ inputs.tune_apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=false \
        TUNE_ENFORCE_TARGETS=false \
        TUNE_WARMUP_MS="${{ inputs.tune_warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.tune_measure_ms }}" \
        TUNE_CHECKSUM_WARMUP_MS="${{ inputs.tune_checksum_warmup_ms }}" \
        TUNE_CHECKSUM_MEASURE_MS="${{ inputs.tune_checksum_measure_ms }}" \
        TUNE_HASH_WARMUP_MS="${{ inputs.tune_hash_warmup_ms }}" \
        TUNE_HASH_MEASURE_MS="${{ inputs.tune_hash_measure_ms }}" \
        TUNE_REPEATS="${{ inputs.tune_repeats }}" \
        TUNE_AGGREGATION="${{ inputs.tune_aggregation }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-ibm-s390x
      artifact_path: tune-results/

  tune-power10:
    if: inputs.run_tune_power10
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-ppc64le-p10
      timeout_minutes: 120
      setup_kind: default
      cache_key: manual-ibm-tune-power10
      tools_mode: none
      toolchain_components: ""
      pre_script: |
        uname -a
        lscpu
      run_script: |
        if [[ "${{ inputs.tune_allow_full_run && 'true' || 'false' }}" != "true" ]] \
          && [[ -z "${{ inputs.tune_only }}" ]]; then
          echo "error: IBM tune requires targeted input. Set tune_only (recommended) or set tune_allow_full_run=true."
          exit 2
        fi
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.tune_quick && 'true' || 'false' }} \
        TUNE_CRATES="${{ inputs.tune_crates }}" \
        TUNE_ONLY="${{ inputs.tune_only }}" \
        TUNE_APPLY=${{ inputs.tune_apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=false \
        TUNE_ENFORCE_TARGETS=false \
        TUNE_WARMUP_MS="${{ inputs.tune_warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.tune_measure_ms }}" \
        TUNE_CHECKSUM_WARMUP_MS="${{ inputs.tune_checksum_warmup_ms }}" \
        TUNE_CHECKSUM_MEASURE_MS="${{ inputs.tune_checksum_measure_ms }}" \
        TUNE_HASH_WARMUP_MS="${{ inputs.tune_hash_warmup_ms }}" \
        TUNE_HASH_MEASURE_MS="${{ inputs.tune_hash_measure_ms }}" \
        TUNE_REPEATS="${{ inputs.tune_repeats }}" \
        TUNE_AGGREGATION="${{ inputs.tune_aggregation }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-ibm-power10
      artifact_path: tune-results/
