name: PR

on:
  pull_request:

concurrency:
  group: fast-pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

permissions:
  contents: read

jobs:
  lane-contract:
    name: Lane Contract (fast-pr)
    runs-on: ubuntu-latest
    steps:
      - name: Assert lane
        run: |
          test "${{ github.event_name }}" = "pull_request"
          echo "lane=fast-pr"

  target-matrix:
    name: Resolve Target Matrix
    needs: lane-contract
    runs-on: ubuntu-latest
    outputs:
      fast_pr: ${{ steps.matrix.outputs.fast_pr }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - name: Load matrix from manifest
        id: matrix
        run: |
          echo "fast_pr=$(python3 scripts/lib/target-matrix.py --format json --key fast_pr)" >> "$GITHUB_OUTPUT"

  ci:
    name: CI (fast)
    needs: [lane-contract, target-matrix]
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ${{ fromJSON(needs.target-matrix.outputs.fast_pr).host_runner }}
      timeout_minutes: 25
      setup_kind: default
      cache_key: fast-pr-linux
      tools_mode: standard
      run_script: |
        just ci-check
        just build
        just test

  no-std:
    name: no_std smoke
    needs: [lane-contract, target-matrix]
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ${{ fromJSON(needs.target-matrix.outputs.fast_pr).host_runner }}
      timeout_minutes: 10
      setup_kind: default
      cache_key: fast-pr-no-std
      tools_mode: minimal
      run_script: |
        TARGET="${{ fromJSON(needs.target-matrix.outputs.fast_pr).no_std_smoke }}"
        rustup target add "$TARGET"
        cargo check -p platform -p traits -p backend --target "$TARGET" --no-default-features --lib

  wasm:
    name: wasm smoke
    needs: [lane-contract, target-matrix]
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ${{ fromJSON(needs.target-matrix.outputs.fast_pr).host_runner }}
      timeout_minutes: 10
      setup_kind: default
      cache_key: fast-pr-wasm
      tools_mode: minimal
      run_script: |
        TARGET="${{ fromJSON(needs.target-matrix.outputs.fast_pr).wasm_smoke }}"
        rustup target add "$TARGET"
        cargo check -p platform -p traits -p backend --target "$TARGET" --no-default-features --features alloc --lib

  complete:
    name: Complete (fast-pr)
    needs: [ci, no-std, wasm]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Assert required lanes
        run: |
          if [ "${{ needs.ci.result }}" != "success" ]; then
            exit 1
          fi
          if [ "${{ needs.no-std.result }}" != "success" ]; then
            exit 1
          fi
          if [ "${{ needs.wasm.result }}" != "success" ]; then
            exit 1
          fi
