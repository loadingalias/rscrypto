name: Weekly

on:
  schedule:
    - cron: "0 3 * * 0"
  workflow_dispatch:

concurrency:
  group: weekly-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_TEST_MODE: weekly
  CARGO_INCREMENTAL: 0

permissions:
  contents: read

jobs:
  lane-contract:
    name: Lane Contract (weekly)
    runs-on: ubuntu-latest
    steps:
      - name: Assert lane
        run: |
          test "${{ github.event_name }}" = "schedule" -o "${{ github.event_name }}" = "workflow_dispatch"
          echo "lane=weekly"

  rail-plan:
    name: Build Plan
    needs: lane-contract
    runs-on: ubuntu-latest
    outputs:
      base_ref: ${{ steps.rail.outputs.base-ref || steps.manual.outputs.base_ref }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Manual dispatch (no change detection)
        if: github.event_name == 'workflow_dispatch'
        id: manual
        run: echo "base_ref=" >> "$GITHUB_OUTPUT"

      - name: Build Plan
        if: github.event_name != 'workflow_dispatch'
        id: rail
        uses: loadingalias/cargo-rail-action@5c8c63658ad8aae2be592d791702773bfc215fc4  # v3.1.1
        with:
          args: "--explain"

  target-matrix:
    name: Resolve Target Matrix
    needs: lane-contract
    runs-on: ubuntu-latest
    outputs:
      weekly_ci: ${{ steps.matrix.outputs.weekly_ci }}
      weekly_no_std: ${{ steps.matrix.outputs.weekly_no_std }}
      weekly_wasm: ${{ steps.matrix.outputs.weekly_wasm }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - name: Load matrix from manifest
        id: matrix
        run: |
          {
            echo "weekly_ci=$(python3 scripts/lib/target-matrix.py --format json --key commit_ci)"
            echo "weekly_no_std=$(python3 scripts/lib/target-matrix.py --format json --key commit_no_std)"
            echo "weekly_wasm=$(python3 scripts/lib/target-matrix.py --format json --key commit_wasm)"
          } >> "$GITHUB_OUTPUT"

  ci:
    name: CI (${{ matrix.target.name }})
    needs: [lane-contract, rail-plan, target-matrix]
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.target-matrix.outputs.weekly_ci) }}
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ${{ matrix.target.runner }}
      timeout_minutes: 45
      setup_kind: default
      cache_key: weekly-${{ matrix.target.name }}
      tools_mode: ${{ contains(matrix.target.name, 'windows-msvc') && 'none' || 'standard' }}
      toolchain_components: ${{ contains(matrix.target.name, 'windows-msvc') && '' || 'clippy, rustfmt, rust-src' }}
      run_script: |
        case "${{ matrix.target.name }}" in
          *windows-msvc)
            echo "Windows weekly lane: compile-only smoke"
            cargo check --workspace --all-targets --all-features
            cargo test --workspace --all-features --no-run
            ;;
          *)
            just ci-check
            just build
            if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
              just test --all
            else
              export RAIL_SINCE="${{ needs.rail-plan.outputs.base_ref }}"
              just test
            fi
            ;;
        esac

  ci-ibm-s390x:
    name: CI (IBM Z s390x)
    needs: [lane-contract, rail-plan]
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-s390x
      timeout_minutes: 90
      setup_kind: default
      cache_key: weekly-ci-s390x
      tools_mode: ibm
      toolchain_components: "clippy, rustfmt"
      pre_script: |
        uname -a
        lscpu
        cat /proc/cpuinfo | head -50
      run_script: |
        just ci-check
        just test --all

  ci-ibm-power10:
    name: CI (IBM POWER10 ppc64le)
    needs: [lane-contract, rail-plan]
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-ppc64le-p10
      timeout_minutes: 90
      setup_kind: default
      cache_key: weekly-ci-power10
      tools_mode: ibm
      toolchain_components: "clippy, rustfmt"
      pre_script: |
        uname -a
        lscpu
        cat /proc/cpuinfo | head -50
      run_script: |
        just ci-check
        just test --all

  no-std:
    name: no_std (${{ matrix.target }})
    needs: [lane-contract, target-matrix]
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.target-matrix.outputs.weekly_no_std) }}
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-latest
      timeout_minutes: 25
      setup_kind: default
      cache_key: weekly-no-std-${{ matrix.target }}
      tools_mode: minimal
      run_script: |
        rustup target add ${{ matrix.target }}
        cargo check -p platform -p traits -p backend -p checksum -p hashes --target ${{ matrix.target }} --no-default-features --lib
        cargo check -p platform -p traits -p backend -p checksum -p hashes --target ${{ matrix.target }} --no-default-features --features alloc --lib
        cargo build -p platform -p traits -p backend -p checksum -p hashes --target ${{ matrix.target }} --no-default-features --lib --release
        cargo build -p platform -p traits -p backend -p checksum -p hashes --target ${{ matrix.target }} --no-default-features --features alloc --lib --release

  wasm:
    name: wasm (${{ matrix.target }})
    needs: [lane-contract, target-matrix]
    strategy:
      fail-fast: false
      matrix:
        target: ${{ fromJSON(needs.target-matrix.outputs.weekly_wasm) }}
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-latest
      timeout_minutes: 25
      setup_kind: default
      cache_key: weekly-wasm-${{ matrix.target }}
      tools_mode: minimal
      run_script: |
        rustup target add ${{ matrix.target }}
        cargo check -p platform -p traits -p backend -p checksum -p hashes --target ${{ matrix.target }} --no-default-features --lib
        cargo check -p platform -p traits -p backend -p checksum -p hashes --target ${{ matrix.target }} --no-default-features --features alloc --lib
        cargo build -p platform -p traits -p backend -p checksum -p hashes --target ${{ matrix.target }} --no-default-features --lib --release
        cargo build -p platform -p traits -p backend -p checksum -p hashes --target ${{ matrix.target }} --no-default-features --features alloc --lib --release

  wasm-pack-optional:
    name: wasm-pack smoke (optional)
    needs: lane-contract
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Setup
        uses: ./.github/actions/setup
        with:
          cache-key: weekly-wasm-pack
          tools-mode: minimal

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: wasm-pack build
        run: wasm-pack build crates/rscrypto --target web --no-default-features --features std

  miri:
    name: Miri (${{ matrix.target.name }})
    needs: lane-contract
    runs-on: ${{ matrix.target.runner }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: x86_64
            runner: ubuntu-latest
          - name: aarch64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Setup
        uses: ./.github/actions/setup
        with:
          cache-key: weekly-miri-${{ matrix.target.name }}
          tools-mode: minimal
          toolchain-components: "miri, rust-src"

      - name: Miri
        run: just test-miri --all

  fuzzing:
    name: Fuzzing (${{ matrix.target.name }})
    needs: lane-contract
    runs-on: ${{ matrix.target.runner }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: x86_64
            runner: ubuntu-latest
          - name: aarch64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Setup
        uses: ./.github/actions/setup
        with:
          cache-key: weekly-fuzz-${{ matrix.target.name }}
          tools-mode: fuzz

      - name: Fuzz
        env:
          RSCRYPTO_FUZZ_DURATION_SECS: "150"
        run: just test-fuzz --all

      - name: Upload Fuzz Crash Artifacts
        if: failure()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: fuzz-crashes-weekly-${{ matrix.target.name }}
          path: crates/**/fuzz/artifacts/
          retention-days: 90
          if-no-files-found: ignore

  complete:
    name: Complete (weekly)
    needs: [ci, ci-ibm-s390x, ci-ibm-power10, no-std, wasm, miri, fuzzing]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Assert required lanes
        run: |
          if [ "${{ needs.ci.result }}" != "success" ]; then
            exit 1
          fi
          if [ "${{ needs.ci-ibm-s390x.result }}" != "success" ]; then
            exit 1
          fi
          if [ "${{ needs.ci-ibm-power10.result }}" != "success" ]; then
            exit 1
          fi
          if [ "${{ needs.no-std.result }}" != "success" ]; then
            exit 1
          fi
          if [ "${{ needs.wasm.result }}" != "success" ]; then
            exit 1
          fi
          if [ "${{ needs.miri.result }}" != "success" ]; then
            exit 1
          fi
          if [ "${{ needs.fuzzing.result }}" != "success" ]; then
            exit 1
          fi
