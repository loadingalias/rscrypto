name: Weekly

on:
  schedule:
    # Run every Sunday at 3AM UTC
    - cron: "0 3 * * 0"

  # Allow manual trigger
  workflow_dispatch:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_TEST_MODE: weekly
  CARGO_INCREMENTAL: 0

# Lock down permissions to read-only by default
permissions:
  contents: read

jobs:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Weekly Validation (Miri + Fuzzing + Extended Property Tests)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  miri:
    name: Miri (${{ matrix.target.name }})
    runs-on: ${{ matrix.target.runner }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: x86_64
            runner: ubuntu-latest
          - name: aarch64
            runner: namespace-profile-rscrypto-linux-arm64
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Read Toolchain Version
        id: toolchain
        run: |
          TOOLCHAIN=$(awk -F'"' '/^channel/ {print $2}' rust-toolchain.toml)
          echo "version=$TOOLCHAIN" >> "$GITHUB_OUTPUT"

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # master
        with:
          toolchain: ${{ steps.toolchain.outputs.version }}
          components: miri, rust-src

      - name: Install Tools
        uses: taiki-e/install-action@7ea888af71a31437ad4e71c62d021b3bb2728ea9  # v2.49.3
        with:
          tool: just

      - name: Miri Memory Safety Tests
        run: just test-miri --all

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Extended Property Tests (more iterations than commit-time tests)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  proptests:
    name: Property Tests (Extended)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Read Toolchain Version
        id: toolchain
        run: |
          TOOLCHAIN=$(awk -F'"' '/^channel/ {print $2}' rust-toolchain.toml)
          echo "version=$TOOLCHAIN" >> "$GITHUB_OUTPUT"

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # master
        with:
          toolchain: ${{ steps.toolchain.outputs.version }}

      - name: Install Tools
        uses: taiki-e/install-action@7ea888af71a31437ad4e71c62d021b3bb2728ea9  # v2.49.3
        with:
          tool: cargo-nextest,just

      - name: Extended Property Tests
        run: cargo nextest run --workspace --all-features -E 'test(/proptest/)' --test-threads=1
        env:
          PROPTEST_CASES: "10000"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Fuzzing: Isolated Job with Fresh Disk Space
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  fuzzing:
    name: Fuzzing (Linux x86-64)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Read Toolchain Version
        id: toolchain
        run: |
          TOOLCHAIN=$(awk -F'"' '/^channel/ {print $2}' rust-toolchain.toml)
          echo "version=$TOOLCHAIN" >> "$GITHUB_OUTPUT"

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # master
        with:
          toolchain: ${{ steps.toolchain.outputs.version }}

      - name: Install Tools
        uses: taiki-e/install-action@7ea888af71a31437ad4e71c62d021b3bb2728ea9  # v2.49.3
        with:
          tool: cargo-fuzz,just

      - name: Fuzz Testing
        env:
          RSCRYPTO_FUZZ_DURATION_SECS: "300"
        run: just test-fuzz --all

      - name: Upload Fuzz Crash Artifacts
        if: failure()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: fuzz-crashes-weekly
          path: fuzz/artifacts/
          retention-days: 90
          if-no-files-found: ignore

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Summary
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  complete:
    name: Weekly Complete
    needs: [miri, proptests, fuzzing]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check Results
        run: |
          echo "Weekly CI Results:"
          echo "  Miri: ${{ needs.miri.result }}"
          echo "  Property Tests: ${{ needs.proptests.result }}"
          echo "  Fuzzing: ${{ needs.fuzzing.result }}"

          if [ "${{ needs.miri.result }}" == "failure" ] || \
             [ "${{ needs.proptests.result }}" == "failure" ] || \
             [ "${{ needs.fuzzing.result }}" == "failure" ]; then
            echo ""
            echo "One or more jobs failed"
            exit 1
          fi

          echo ""
          echo "All weekly jobs passed"
