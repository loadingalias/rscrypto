name: scheduled-bench

on:
  schedule:
    - cron: "0 4 1,15 * *"

concurrency:
  group: scheduled-bench-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_BENCH_MODE: ci
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-C target-cpu=native"

permissions:
  contents: read

jobs:
  lane-contract:
    name: Lane Contract (scheduled-bench)
    runs-on: ubuntu-latest
    steps:
      - name: Assert lane
        run: |
          test "${{ github.event_name }}" = "schedule"
          echo "lane=scheduled-bench"

  bench-amd-zen4:
    name: Benchmark (AMD Zen4)
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: namespace-profile-rscrypto-linux-x86
      timeout_minutes: 90
      setup_kind: namespace
      run_script: |
        rm -rf target/criterion
        mkdir -p benchmark-results
        cargo bench --profile bench --workspace 2>&1 | tee benchmark-results/output.txt
      artifact_name: benchmark-amd-zen4
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-intel:
    name: Benchmark (Intel)
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=intel-bench
      timeout_minutes: 90
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        rm -rf target/criterion
        mkdir -p benchmark-results
        cargo bench --profile bench --workspace 2>&1 | tee benchmark-results/output.txt
      artifact_name: benchmark-intel
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-graviton:
    name: Benchmark (Graviton)
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=graviton
      timeout_minutes: 90
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        rm -rf target/criterion
        mkdir -p benchmark-results
        cargo bench --profile bench --workspace 2>&1 | tee benchmark-results/output.txt
      artifact_name: benchmark-graviton
      artifact_path: |
        benchmark-results/
        target/criterion/
