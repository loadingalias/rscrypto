name: Bench

on:
  workflow_dispatch:
    inputs:
      run_amd_zen4:
        description: "Run benchmarks on AMD Zen4 (Namespace)"
        required: false
        type: boolean
        default: true
      run_intel_spr:
        description: "Run benchmarks on Intel Sapphire Rapids (World Record contender)"
        required: false
        type: boolean
        default: true
      run_intel_latest:
        description: "Run benchmarks on Intel Latest (Granite/Emerald/Sapphire)"
        required: false
        type: boolean
        default: false
      run_intel_icl:
        description: "Run benchmarks on Intel Ice Lake (SSE validation)"
        required: false
        type: boolean
        default: false
      run_graviton:
        description: "Run benchmarks on Graviton (RunsOn)"
        required: false
        type: boolean
        default: true
      run_amd_zen5:
        description: "Run benchmarks on AMD Zen5 (RunsOn)"
        required: false
        type: boolean
        default: false
      crates:
        description: "Benchmark crates (comma-separated, empty = workspace)"
        required: false
        type: string
        default: ""
      benches:
        description: "Specific benches (comma-separated, optional)"
        required: false
        type: string
        default: ""

concurrency:
  group: manual-bench-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_BENCH_MODE: ci
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-C target-cpu=native"

permissions:
  contents: read

jobs:
  lane-contract:
    name: Lane Contract (manual-bench)
    runs-on: ubuntu-latest
    steps:
      - name: Assert lane
        run: |
          test "${{ github.event_name }}" = "workflow_dispatch"
          echo "lane=manual-bench"

  bench-amd-zen4:
    name: Benchmark (AMD Zen4)
    if: github.event.inputs.run_amd_zen4 == 'true'
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: namespace-profile-rscrypto-linux-x86
      timeout_minutes: 90
      setup_kind: namespace
      run_script: |
        CRATES_INPUT="${{ github.event.inputs.crates }}"
        BENCHES_INPUT="${{ github.event.inputs.benches }}"
        CRATE_FLAGS="--workspace"
        BENCH_FLAGS=""
        if [ -n "$CRATES_INPUT" ]; then
          CRATE_FLAGS=""
          IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
          for crate in "${CRATES[@]}"; do
            CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
          done
        fi
        if [ -n "$BENCHES_INPUT" ]; then
          IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
          for bench in "${BENCHES[@]}"; do
            BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
          done
        fi
        rm -rf target/criterion
        mkdir -p benchmark-results
        # shellcheck disable=SC2086
        cargo bench --profile bench $CRATE_FLAGS $BENCH_FLAGS 2>&1 | tee benchmark-results/output.txt
      artifact_name: benchmark-amd-zen4
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-intel-spr:
    name: Benchmark (Intel Sapphire Rapids)
    if: github.event.inputs.run_intel_spr == 'true'
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=intel-spr
      timeout_minutes: 90
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        CRATES_INPUT="${{ github.event.inputs.crates }}"
        BENCHES_INPUT="${{ github.event.inputs.benches }}"
        CRATE_FLAGS="--workspace"
        BENCH_FLAGS=""
        if [ -n "$CRATES_INPUT" ]; then
          CRATE_FLAGS=""
          IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
          for crate in "${CRATES[@]}"; do
            CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
          done
        fi
        if [ -n "$BENCHES_INPUT" ]; then
          IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
          for bench in "${BENCHES[@]}"; do
            BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
          done
        fi
        rm -rf target/criterion
        mkdir -p benchmark-results
        # shellcheck disable=SC2086
        cargo bench --profile bench $CRATE_FLAGS $BENCH_FLAGS 2>&1 | tee benchmark-results/output.txt
      artifact_name: benchmark-intel-spr
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-intel-latest:
    name: Benchmark (Intel Latest)
    if: github.event.inputs.run_intel_latest == 'true'
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=intel-latest
      timeout_minutes: 90
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        CRATES_INPUT="${{ github.event.inputs.crates }}"
        BENCHES_INPUT="${{ github.event.inputs.benches }}"
        CRATE_FLAGS="--workspace"
        BENCH_FLAGS=""
        if [ -n "$CRATES_INPUT" ]; then
          CRATE_FLAGS=""
          IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
          for crate in "${CRATES[@]}"; do
            CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
          done
        fi
        if [ -n "$BENCHES_INPUT" ]; then
          IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
          for bench in "${BENCHES[@]}"; do
            BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
          done
        fi
        rm -rf target/criterion
        mkdir -p benchmark-results
        # shellcheck disable=SC2086
        cargo bench --profile bench $CRATE_FLAGS $BENCH_FLAGS 2>&1 | tee benchmark-results/output.txt
      artifact_name: benchmark-intel-latest
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-intel-icl:
    name: Benchmark (Intel Ice Lake - SSE validation)
    if: github.event.inputs.run_intel_icl == 'true'
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=intel-icl-bench
      timeout_minutes: 90
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        CRATES_INPUT="${{ github.event.inputs.crates }}"
        BENCHES_INPUT="${{ github.event.inputs.benches }}"
        CRATE_FLAGS="--workspace"
        BENCH_FLAGS=""
        if [ -n "$CRATES_INPUT" ]; then
          CRATE_FLAGS=""
          IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
          for crate in "${CRATES[@]}"; do
            CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
          done
        fi
        if [ -n "$BENCHES_INPUT" ]; then
          IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
          for bench in "${BENCHES[@]}"; do
            BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
          done
        fi
        rm -rf target/criterion
        mkdir -p benchmark-results
        # shellcheck disable=SC2086
        cargo bench --profile bench $CRATE_FLAGS $BENCH_FLAGS 2>&1 | tee benchmark-results/output.txt
      artifact_name: benchmark-intel-icl
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-amd-zen5:
    name: Benchmark (AMD Zen5)
    if: github.event.inputs.run_amd_zen5 == 'true'
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=amd-zen5
      timeout_minutes: 90
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        CRATES_INPUT="${{ github.event.inputs.crates }}"
        BENCHES_INPUT="${{ github.event.inputs.benches }}"
        CRATE_FLAGS="--workspace"
        BENCH_FLAGS=""
        if [ -n "$CRATES_INPUT" ]; then
          CRATE_FLAGS=""
          IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
          for crate in "${CRATES[@]}"; do
            CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
          done
        fi
        if [ -n "$BENCHES_INPUT" ]; then
          IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
          for bench in "${BENCHES[@]}"; do
            BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
          done
        fi
        rm -rf target/criterion
        mkdir -p benchmark-results
        # shellcheck disable=SC2086
        cargo bench --profile bench $CRATE_FLAGS $BENCH_FLAGS 2>&1 | tee benchmark-results/output.txt
      artifact_name: benchmark-amd-zen5
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-graviton:
    name: Benchmark (Graviton)
    if: github.event.inputs.run_graviton == 'true'
    needs: lane-contract
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=graviton
      timeout_minutes: 90
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        CRATES_INPUT="${{ github.event.inputs.crates }}"
        BENCHES_INPUT="${{ github.event.inputs.benches }}"
        CRATE_FLAGS="--workspace"
        BENCH_FLAGS=""
        if [ -n "$CRATES_INPUT" ]; then
          CRATE_FLAGS=""
          IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
          for crate in "${CRATES[@]}"; do
            CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
          done
        fi
        if [ -n "$BENCHES_INPUT" ]; then
          IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
          for bench in "${BENCHES[@]}"; do
            BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
          done
        fi
        rm -rf target/criterion
        mkdir -p benchmark-results
        # shellcheck disable=SC2086
        cargo bench --profile bench $CRATE_FLAGS $BENCH_FLAGS 2>&1 | tee benchmark-results/output.txt
      artifact_name: benchmark-graviton
      artifact_path: |
        benchmark-results/
        target/criterion/
