name: Benchmark

on:
  schedule:
    # Run every other Sunday at 4AM UTC (1st and 15th for bi-weekly pattern)
    - cron: "0 4 1,15 * *"

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      crates:
        description: "Crate(s) to benchmark (comma-separated, leave empty for all)"
        required: false
        type: string
        default: ""

      # ─────────────────────────────────────────────────────────────────────────
      # Intel x86-64 (RunsOn: Granite/Emerald/Sapphire Rapids, Ice Lake)
      # ─────────────────────────────────────────────────────────────────────────
      run_intel:
        description: "Run on Intel (Granite/Emerald/Sapphire Rapids)"
        required: false
        type: boolean
        default: true

      run_intel_icl:
        description: "Run on Intel Ice Lake (c6i/m6i - 3rd Gen Xeon)"
        required: false
        type: boolean
        default: false

      # ─────────────────────────────────────────────────────────────────────────
      # AMD x86-64 (Namespace: Zen4, RunsOn: Zen5)
      # ─────────────────────────────────────────────────────────────────────────
      run_amd_zen4:
        description: "Run on AMD Zen4 (Namespace)"
        required: false
        type: boolean
        default: true

      run_amd_zen5:
        description: "Run on AMD Zen5 Turin (RunsOn)"
        required: false
        type: boolean
        default: false

      # ─────────────────────────────────────────────────────────────────────────
      # ARM64 Graviton (RunsOn)
      # ─────────────────────────────────────────────────────────────────────────
      run_graviton:
        description: "Run on Graviton (Neoverse V2/V1, RunsOn)"
        required: false
        type: boolean
        default: true

      # ─────────────────────────────────────────────────────────────────────────
      # RISC-V 64 (Self-hosted Cloud-V)
      # ─────────────────────────────────────────────────────────────────────────
      run_riscv:
        description: "Run on RISC-V 64 (Self-hosted Cloud-V)"
        required: false
        type: boolean
        default: false

      specific_benches:
        description: "Specific benchmark binary names (optional, comma-separated)"
        required: false
        type: string
        default: ""

      tune:
        description: "Run unified tuning only (skip Criterion benchmarks)"
        required: false
        type: boolean
        default: false

      regression_baseline:
        description: "Git ref for regression comparison (e.g., main, v1.0.0)"
        required: false
        type: string
        default: ""

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_BENCH_MODE: ci
  CARGO_INCREMENTAL: 0
  # Ensure benchmark builds use the host CPU features
  RUSTFLAGS: "-C target-cpu=native"

# Lock down permissions to read-only by default
permissions:
  contents: read

jobs:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # AMD ZEN4 BENCHMARKS (Namespace - strong dedicated runners)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # EPYC 9R14 (Genoa) - Namespace provides excellent Zen4 runners
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  bench-amd-zen4:
    name: Benchmark (AMD Zen4)
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       github.event.inputs.tune != 'true' &&
       github.event.inputs.run_amd_zen4 == 'true')
    runs-on: namespace-profile-rscrypto-linux-x86
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup Namespace Cache
        uses: namespacelabs/nscloud-cache-action@446d8f390563cd54ca27e8de5bdb816f63c0b706 # v1.2.21
        with:
          cache: rust

      - name: Detect CPU
        id: cpu
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "CPU Detection"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          lscpu | grep -E "Model name|Vendor|CPU\(s\)|Thread"
          echo "uarch=zen4-genoa" >> "$GITHUB_OUTPUT"

      - name: Read Toolchain Version
        id: toolchain
        run: |
          TOOLCHAIN=$(awk -F'"' '/^channel/ {print $2}' rust-toolchain.toml)
          echo "version=$TOOLCHAIN" >> "$GITHUB_OUTPUT"

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: ${{ steps.toolchain.outputs.version }}

      - name: Install Benchmarking Tools
        uses: taiki-e/install-action@7ea888af71a31437ad4e71c62d021b3bb2728ea9 # v2.49.3
        with:
          tool: cargo-criterion,critcmp,just,cargo-rail

      - name: Determine Benchmark Scope
        id: scope
        run: |
          CRATES_INPUT="${{ github.event.inputs.crates }}"
          BENCHES_INPUT="${{ github.event.inputs.specific_benches }}"

          if [ "${{ github.event_name }}" == "schedule" ]; then
            AFFECTED=$(cargo rail affected --since HEAD~50 -f names-only 2>/dev/null || echo "")
            if [ -z "$AFFECTED" ]; then
              echo "crate_flags=--workspace" >> "$GITHUB_OUTPUT"
            else
              CRATE_FLAGS=""
              while IFS= read -r crate; do
                [ -n "$crate" ] && CRATE_FLAGS="$CRATE_FLAGS -p $crate"
              done <<< "$AFFECTED"
              echo "crate_flags=$CRATE_FLAGS" >> "$GITHUB_OUTPUT"
            fi
            echo "bench_flags=" >> "$GITHUB_OUTPUT"
          else
            if [ -n "$CRATES_INPUT" ]; then
              CRATE_FLAGS=""
              IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
              for crate in "${CRATES[@]}"; do
                CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
              done
              echo "crate_flags=$CRATE_FLAGS" >> "$GITHUB_OUTPUT"
            else
              echo "crate_flags=--workspace" >> "$GITHUB_OUTPUT"
            fi
            if [ -n "$BENCHES_INPUT" ]; then
              BENCH_FLAGS=""
              IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
              for bench in "${BENCHES[@]}"; do
                BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
              done
              echo "bench_flags=$BENCH_FLAGS" >> "$GITHUB_OUTPUT"
            else
              echo "bench_flags=" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Clean Old Benchmark Data
        run: rm -rf target/criterion

      - name: Run Criterion Benchmarks
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running Criterion Benchmarks (AMD Zen4)"
          echo "RUSTFLAGS: ${RUSTFLAGS}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          mkdir -p benchmark-results
          # shellcheck disable=SC2086
          cargo bench --profile bench ${{ steps.scope.outputs.crate_flags }} ${{ steps.scope.outputs.bench_flags }} 2>&1 | tee benchmark-results/output.txt

      - name: Upload Benchmark Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: benchmark-amd-zen4
          path: |
            benchmark-results/
            target/criterion/
          retention-days: 90

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # AMD ZEN5 BENCHMARKS (RunsOn - Turin)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # EPYC 9R45 @ 4.5GHz - Latest AMD with AVX-512
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  bench-amd-zen5:
    name: Benchmark (AMD Zen5)
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.tune != 'true' &&
      github.event.inputs.run_amd_zen5 == 'true'
    runs-on: runs-on=${{ github.run_id }}/runner=amd-zen5
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup RunsOn
        uses: ./.github/actions/setup-runson
        with:
          mode: runson-bench

      - name: Determine Benchmark Scope
        id: scope
        run: |
          CRATES_INPUT="${{ github.event.inputs.crates }}"
          BENCHES_INPUT="${{ github.event.inputs.specific_benches }}"

          if [ -n "$CRATES_INPUT" ]; then
            CRATE_FLAGS=""
            IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
            for crate in "${CRATES[@]}"; do
              CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
            done
            echo "crate_flags=$CRATE_FLAGS" >> "$GITHUB_OUTPUT"
          else
            echo "crate_flags=--workspace" >> "$GITHUB_OUTPUT"
          fi
          if [ -n "$BENCHES_INPUT" ]; then
            BENCH_FLAGS=""
            IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
            for bench in "${BENCHES[@]}"; do
              BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
            done
            echo "bench_flags=$BENCH_FLAGS" >> "$GITHUB_OUTPUT"
          else
            echo "bench_flags=" >> "$GITHUB_OUTPUT"
          fi

      - name: Clean Old Benchmark Data
        run: rm -rf target/criterion

      - name: Run Criterion Benchmarks
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running Criterion Benchmarks (AMD Zen5 Turin)"
          echo "RUSTFLAGS: ${RUSTFLAGS}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          mkdir -p benchmark-results
          # shellcheck disable=SC2086
          cargo bench --profile bench ${{ steps.scope.outputs.crate_flags }} ${{ steps.scope.outputs.bench_flags }} 2>&1 | tee benchmark-results/output.txt

      - name: Upload Benchmark Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: benchmark-amd-zen5
          path: |
            benchmark-results/
            target/criterion/
          retention-days: 90

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # INTEL BENCHMARKS (RunsOn - Granite/Emerald/Sapphire Rapids)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Fallback chain: m8i/r8i → i7i/i7ie → c7i/m7i
  # All have: AVX-512, VPCLMULQDQ, GFNI (critical for CRC/crypto)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  bench-intel:
    name: Benchmark (Intel)
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       github.event.inputs.tune != 'true' &&
       github.event.inputs.run_intel == 'true')
    runs-on: runs-on=${{ github.run_id }}/runner=intel-bench
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup RunsOn
        uses: ./.github/actions/setup-runson
        with:
          mode: runson-bench

      - name: Determine Benchmark Scope
        id: scope
        run: |
          CRATES_INPUT="${{ github.event.inputs.crates }}"
          BENCHES_INPUT="${{ github.event.inputs.specific_benches }}"

          if [ "${{ github.event_name }}" == "schedule" ]; then
            AFFECTED=$(cargo rail affected --since HEAD~50 -f names-only 2>/dev/null || echo "")
            if [ -z "$AFFECTED" ]; then
              echo "crate_flags=--workspace" >> "$GITHUB_OUTPUT"
            else
              CRATE_FLAGS=""
              while IFS= read -r crate; do
                [ -n "$crate" ] && CRATE_FLAGS="$CRATE_FLAGS -p $crate"
              done <<< "$AFFECTED"
              echo "crate_flags=$CRATE_FLAGS" >> "$GITHUB_OUTPUT"
            fi
            echo "bench_flags=" >> "$GITHUB_OUTPUT"
          else
            if [ -n "$CRATES_INPUT" ]; then
              CRATE_FLAGS=""
              IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
              for crate in "${CRATES[@]}"; do
                CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
              done
              echo "crate_flags=$CRATE_FLAGS" >> "$GITHUB_OUTPUT"
            else
              echo "crate_flags=--workspace" >> "$GITHUB_OUTPUT"
            fi
            if [ -n "$BENCHES_INPUT" ]; then
              BENCH_FLAGS=""
              IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
              for bench in "${BENCHES[@]}"; do
                BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
              done
              echo "bench_flags=$BENCH_FLAGS" >> "$GITHUB_OUTPUT"
            else
              echo "bench_flags=" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Install cargo-rail (scheduled runs)
        if: github.event_name == 'schedule'
        uses: taiki-e/install-action@7ea888af71a31437ad4e71c62d021b3bb2728ea9 # v2.49.3
        with:
          tool: cargo-rail

      - name: Clean Old Benchmark Data
        run: rm -rf target/criterion

      - name: Run Criterion Benchmarks
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running Criterion Benchmarks (Intel)"
          echo "RUSTFLAGS: ${RUSTFLAGS}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          mkdir -p benchmark-results
          # shellcheck disable=SC2086
          cargo bench --profile bench ${{ steps.scope.outputs.crate_flags }} ${{ steps.scope.outputs.bench_flags }} 2>&1 | tee benchmark-results/output.txt

      - name: Upload Benchmark Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: benchmark-intel
          path: |
            benchmark-results/
            target/criterion/
          retention-days: 90

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # INTEL ICE LAKE BENCHMARKS (RunsOn - 3rd Gen Xeon)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Xeon Platinum 8375C (Ice Lake) - Different AVX-512 characteristics
  # Prefers 256-bit ops over 512-bit, validates IntelIcl tuning preset
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  bench-intel-icl:
    name: Benchmark (Intel Ice Lake)
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.tune != 'true' &&
      github.event.inputs.run_intel_icl == 'true'
    runs-on: runs-on=${{ github.run_id }}/runner=intel-icl-bench
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup RunsOn
        uses: ./.github/actions/setup-runson
        with:
          mode: runson-bench

      - name: Determine Benchmark Scope
        id: scope
        run: |
          CRATES_INPUT="${{ github.event.inputs.crates }}"
          BENCHES_INPUT="${{ github.event.inputs.specific_benches }}"

          if [ -n "$CRATES_INPUT" ]; then
            CRATE_FLAGS=""
            IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
            for crate in "${CRATES[@]}"; do
              CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
            done
            echo "crate_flags=$CRATE_FLAGS" >> "$GITHUB_OUTPUT"
          else
            echo "crate_flags=--workspace" >> "$GITHUB_OUTPUT"
          fi
          if [ -n "$BENCHES_INPUT" ]; then
            BENCH_FLAGS=""
            IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
            for bench in "${BENCHES[@]}"; do
              BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
            done
            echo "bench_flags=$BENCH_FLAGS" >> "$GITHUB_OUTPUT"
          else
            echo "bench_flags=" >> "$GITHUB_OUTPUT"
          fi

      - name: Clean Old Benchmark Data
        run: rm -rf target/criterion

      - name: Run Criterion Benchmarks
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running Criterion Benchmarks (Intel Ice Lake)"
          echo "RUSTFLAGS: ${RUSTFLAGS}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          mkdir -p benchmark-results
          # shellcheck disable=SC2086
          cargo bench --profile bench ${{ steps.scope.outputs.crate_flags }} ${{ steps.scope.outputs.bench_flags }} 2>&1 | tee benchmark-results/output.txt

      - name: Upload Benchmark Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: benchmark-intel-icl
          path: |
            benchmark-results/
            target/criterion/
          retention-days: 90

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # GRAVITON BENCHMARKS (RunsOn - Best Available)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Fallback: Graviton 4 (Neoverse V2) → Graviton 3 (Neoverse V1)
  # NOT Graviton 2 (N1) - GitHub free already provides that
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  bench-graviton:
    name: Benchmark (Graviton)
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       github.event.inputs.tune != 'true' &&
       github.event.inputs.run_graviton == 'true')
    runs-on: runs-on=${{ github.run_id }}/runner=graviton
    timeout-minutes: 90
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup RunsOn
        uses: ./.github/actions/setup-runson
        with:
          mode: runson-bench

      - name: Determine Benchmark Scope
        id: scope
        run: |
          CRATES_INPUT="${{ github.event.inputs.crates }}"
          BENCHES_INPUT="${{ github.event.inputs.specific_benches }}"

          if [ "${{ github.event_name }}" == "schedule" ]; then
            AFFECTED=$(cargo rail affected --since HEAD~50 -f names-only 2>/dev/null || echo "")
            if [ -z "$AFFECTED" ]; then
              echo "crate_flags=--workspace" >> "$GITHUB_OUTPUT"
            else
              CRATE_FLAGS=""
              while IFS= read -r crate; do
                [ -n "$crate" ] && CRATE_FLAGS="$CRATE_FLAGS -p $crate"
              done <<< "$AFFECTED"
              echo "crate_flags=$CRATE_FLAGS" >> "$GITHUB_OUTPUT"
            fi
            echo "bench_flags=" >> "$GITHUB_OUTPUT"
          else
            if [ -n "$CRATES_INPUT" ]; then
              CRATE_FLAGS=""
              IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
              for crate in "${CRATES[@]}"; do
                CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
              done
              echo "crate_flags=$CRATE_FLAGS" >> "$GITHUB_OUTPUT"
            else
              echo "crate_flags=--workspace" >> "$GITHUB_OUTPUT"
            fi
            if [ -n "$BENCHES_INPUT" ]; then
              BENCH_FLAGS=""
              IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
              for bench in "${BENCHES[@]}"; do
                BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
              done
              echo "bench_flags=$BENCH_FLAGS" >> "$GITHUB_OUTPUT"
            else
              echo "bench_flags=" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Install cargo-rail (scheduled runs)
        if: github.event_name == 'schedule'
        uses: taiki-e/install-action@7ea888af71a31437ad4e71c62d021b3bb2728ea9 # v2.49.3
        with:
          tool: cargo-rail

      - name: Clean Old Benchmark Data
        run: rm -rf target/criterion

      - name: Run Criterion Benchmarks
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running Criterion Benchmarks (Graviton)"
          echo "RUSTFLAGS: ${RUSTFLAGS}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          mkdir -p benchmark-results
          # shellcheck disable=SC2086
          cargo bench --profile bench ${{ steps.scope.outputs.crate_flags }} ${{ steps.scope.outputs.bench_flags }} 2>&1 | tee benchmark-results/output.txt

      - name: Upload Benchmark Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: benchmark-graviton
          path: |
            benchmark-results/
            target/criterion/
          retention-days: 90

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # RISC-V 64 BENCHMARKS (Self-hosted Cloud-V)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # DISABLED: Cloud-V runner is not currently operational.
  # Uncomment when RISC-V self-hosted runner is available again.
  # bench-riscv:
  #   name: Benchmark (RISC-V 64)
  #   if: |
  #     github.event_name == 'workflow_dispatch' &&
  #     github.event.inputs.tune != 'true' &&
  #     github.event.inputs.run_riscv == 'true'
  #   runs-on: [self-hosted, 2c6cf205228d]
  #   timeout-minutes: 120
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
  #       with:
  #         fetch-depth: 0
  #
  #     - name: Detect CPU
  #       run: |
  #         echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  #         echo "RISC-V CPU Detection"
  #         echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  #         cat /proc/cpuinfo | head -30 || true
  #         echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  #
  #     - name: Setup Toolchain
  #       run: |
  #         TOOLCHAIN=$(awk -F'"' '/^channel/ {print $2}' rust-toolchain.toml)
  #         rustup default "$TOOLCHAIN"
  #
  #     - name: Install Benchmarking Tools
  #       run: |
  #         cargo install --locked cargo-criterion critcmp || true
  #
  #     - name: Determine Benchmark Scope
  #       id: scope
  #       run: |
  #         CRATES_INPUT="${{ github.event.inputs.crates }}"
  #         BENCHES_INPUT="${{ github.event.inputs.specific_benches }}"
  #
  #         if [ -n "$CRATES_INPUT" ]; then
  #           CRATE_FLAGS=""
  #           IFS=',' read -ra CRATES <<< "$CRATES_INPUT"
  #           for crate in "${CRATES[@]}"; do
  #             CRATE_FLAGS="$CRATE_FLAGS -p $(echo "$crate" | xargs)"
  #           done
  #           echo "crate_flags=$CRATE_FLAGS" >> "$GITHUB_OUTPUT"
  #         else
  #           echo "crate_flags=--workspace" >> "$GITHUB_OUTPUT"
  #         fi
  #         if [ -n "$BENCHES_INPUT" ]; then
  #           BENCH_FLAGS=""
  #           IFS=',' read -ra BENCHES <<< "$BENCHES_INPUT"
  #           for bench in "${BENCHES[@]}"; do
  #             BENCH_FLAGS="$BENCH_FLAGS --bench $(echo "$bench" | xargs)"
  #           done
  #           echo "bench_flags=$BENCH_FLAGS" >> "$GITHUB_OUTPUT"
  #         else
  #           echo "bench_flags=" >> "$GITHUB_OUTPUT"
  #         fi
  #
  #     - name: Clean Old Benchmark Data
  #       run: rm -rf target/criterion
  #
  #     - name: Run Criterion Benchmarks
  #       run: |
  #         echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  #         echo "Running Criterion Benchmarks (RISC-V 64)"
  #         echo "RUSTFLAGS: ${RUSTFLAGS}"
  #         echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  #         mkdir -p benchmark-results
  #         # shellcheck disable=SC2086
  #         cargo bench --profile bench ${{ steps.scope.outputs.crate_flags }} ${{ steps.scope.outputs.bench_flags }} 2>&1 | tee benchmark-results/output.txt
  #
  #     - name: Upload Benchmark Results
  #       if: always()
  #       uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
  #       with:
  #         name: benchmark-riscv64
  #         path: |
  #           benchmark-results/
  #           target/criterion/
  #         retention-days: 90

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # UNIFIED TUNING (Manual Only)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Runs `rscrypto-tune` to generate recommended kernel selection tables.
  # Outputs RSCRYPTO_CRC*_* environment variable recommendations.
  # Each job only runs when tune=true AND the specific platform is enabled,
  # ensuring runners are only allocated for selected platforms.
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  tune-intel:
    name: Tuning (Intel)
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.tune == 'true' &&
      github.event.inputs.run_intel == 'true'
    runs-on: runs-on=${{ github.run_id }}/runner=intel-bench
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup RunsOn
        uses: ./.github/actions/setup-runson
        with:
          mode: runson-bench

      - name: Run Unified Tuning
        run: |
          set -euo pipefail
          mkdir -p tune-results

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running rscrypto-tune (Intel)"
          echo "RUSTFLAGS: -C target-cpu=native"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          RUSTC_WRAPPER='' RUSTFLAGS='-C target-cpu=native' \
            cargo run -p tune --release --bin rscrypto-tune -- --quick 2>&1 | \
            tee tune-results/rscrypto-tune.txt

          {
            echo ""
            echo "## Tuning Results (Intel)"
            echo ""
            echo '```'
            cat tune-results/rscrypto-tune.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Tuning Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: tuning-intel
          path: tune-results/
          retention-days: 90

  tune-intel-icl:
    name: Tuning (Intel Ice Lake)
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.tune == 'true' &&
      github.event.inputs.run_intel_icl == 'true'
    runs-on: runs-on=${{ github.run_id }}/runner=intel-icl-bench
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Setup RunsOn
        uses: ./.github/actions/setup-runson
        with:
          mode: runson-bench

      - name: Run Unified Tuning
        run: |
          set -euo pipefail
          mkdir -p tune-results

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running rscrypto-tune (Intel Ice Lake)"
          echo "RUSTFLAGS: -C target-cpu=native"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          RUSTC_WRAPPER='' RUSTFLAGS='-C target-cpu=native' \
            cargo run -p tune --release --bin rscrypto-tune -- --quick 2>&1 | \
            tee tune-results/rscrypto-tune.txt

          {
            echo ""
            echo "## Tuning Results (Intel Ice Lake)"
            echo ""
            echo '```'
            cat tune-results/rscrypto-tune.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Tuning Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: tuning-intel-icl
          path: tune-results/
          retention-days: 90

  tune-amd-zen4:
    name: Tuning (AMD Zen4)
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.tune == 'true' &&
      github.event.inputs.run_amd_zen4 == 'true'
    runs-on: namespace-profile-rscrypto-linux-x86
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Namespace Cache
        uses: namespacelabs/nscloud-cache-action@446d8f390563cd54ca27e8de5bdb816f63c0b706 # v1.2.21
        with:
          cache: rust

      - name: Setup Toolchain
        run: |
          TOOLCHAIN=$(awk -F'"' '/^channel/ {print $2}' rust-toolchain.toml)
          rustup default "$TOOLCHAIN"
          scripts/ci/install-tools.sh bench

      - name: Run Unified Tuning
        run: |
          set -euo pipefail
          mkdir -p tune-results

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running rscrypto-tune (AMD Zen4)"
          echo "RUSTFLAGS: -C target-cpu=native"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          RUSTC_WRAPPER='' RUSTFLAGS='-C target-cpu=native' \
            cargo run -p tune --release --bin rscrypto-tune -- --quick 2>&1 | \
            tee tune-results/rscrypto-tune.txt

          {
            echo ""
            echo "## Tuning Results (AMD Zen4)"
            echo ""
            echo '```'
            cat tune-results/rscrypto-tune.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Tuning Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: tuning-amd-zen4
          path: tune-results/
          retention-days: 90

  tune-amd-zen5:
    name: Tuning (AMD Zen5)
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.tune == 'true' &&
      github.event.inputs.run_amd_zen5 == 'true'
    runs-on: runs-on=${{ github.run_id }}/runner=amd-zen5
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup RunsOn
        uses: ./.github/actions/setup-runson
        with:
          mode: runson-bench

      - name: Run Unified Tuning
        run: |
          set -euo pipefail
          mkdir -p tune-results

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running rscrypto-tune (AMD Zen5)"
          echo "RUSTFLAGS: -C target-cpu=native"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          RUSTC_WRAPPER='' RUSTFLAGS='-C target-cpu=native' \
            cargo run -p tune --release --bin rscrypto-tune -- --quick 2>&1 | \
            tee tune-results/rscrypto-tune.txt

          {
            echo ""
            echo "## Tuning Results (AMD Zen5)"
            echo ""
            echo '```'
            cat tune-results/rscrypto-tune.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Tuning Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: tuning-amd-zen5
          path: tune-results/
          retention-days: 90

  tune-graviton:
    name: Tuning (Graviton)
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.tune == 'true' &&
      github.event.inputs.run_graviton == 'true'
    runs-on: runs-on=${{ github.run_id }}/runner=graviton
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup RunsOn
        uses: ./.github/actions/setup-runson
        with:
          mode: runson-bench

      - name: Run Unified Tuning
        run: |
          set -euo pipefail
          mkdir -p tune-results

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Running rscrypto-tune (Graviton)"
          echo "RUSTFLAGS: -C target-cpu=native"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          RUSTC_WRAPPER='' RUSTFLAGS='-C target-cpu=native' \
            cargo run -p tune --release --bin rscrypto-tune -- --quick 2>&1 | \
            tee tune-results/rscrypto-tune.txt

          {
            echo ""
            echo "## Tuning Results (Graviton)"
            echo ""
            echo '```'
            cat tune-results/rscrypto-tune.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Tuning Results
        if: always()
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: tuning-graviton
          path: tune-results/
          retention-days: 90

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # RISC-V 64 TUNING (Self-hosted Cloud-V)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # DISABLED: Cloud-V runner is not currently operational.
  # Uncomment when RISC-V self-hosted runner is available again.
  # tune-riscv:
  #   name: Tuning (RISC-V 64)
  #   if: |
  #     github.event_name == 'workflow_dispatch' &&
  #     github.event.inputs.tune == 'true' &&
  #     github.event.inputs.run_riscv == 'true'
  #   runs-on: [self-hosted, 2c6cf205228d]
  #   timeout-minutes: 90
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
  #
  #     - name: Detect CPU
  #       run: |
  #         echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  #         echo "RISC-V CPU Detection"
  #         echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  #         cat /proc/cpuinfo | head -30 || true
  #         echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  #
  #     - name: Setup Toolchain
  #       run: |
  #         TOOLCHAIN=$(awk -F'"' '/^channel/ {print $2}' rust-toolchain.toml)
  #         rustup default "$TOOLCHAIN"
  #
  #     - name: Run Unified Tuning
  #       run: |
  #         set -euo pipefail
  #         mkdir -p tune-results
  #
  #         echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  #         echo "Running rscrypto-tune (RISC-V 64)"
  #         echo "RUSTFLAGS: -C target-cpu=native"
  #         echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  #
  #         RUSTC_WRAPPER='' RUSTFLAGS='-C target-cpu=native' \
  #           cargo run -p tune --release --bin rscrypto-tune -- --quick 2>&1 | \
  #           tee tune-results/rscrypto-tune.txt
  #
  #         {
  #           echo ""
  #           echo "## Tuning Results (RISC-V 64)"
  #           echo ""
  #           echo '```'
  #           cat tune-results/rscrypto-tune.txt
  #           echo '```'
  #         } >> "$GITHUB_STEP_SUMMARY"
  #
  #     - name: Upload Tuning Results
  #       if: always()
  #       uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
  #       with:
  #         name: tuning-riscv64
  #         path: tune-results/
  #         retention-days: 90

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # REGRESSION DETECTION (Manual Only)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  regression-check:
    name: Regression Check
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.regression_baseline != '' &&
      github.event.inputs.tune != 'true'
    runs-on: namespace-profile-rscrypto-linux-x86
    timeout-minutes: 60
    steps:
      - name: Checkout Current
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          path: current

      - name: Checkout Baseline
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.event.inputs.regression_baseline }}
          path: baseline

      - name: Read Toolchain Version
        id: toolchain
        run: |
          TOOLCHAIN=$(awk -F'"' '/^channel/ {print $2}' current/rust-toolchain.toml)
          echo "version=$TOOLCHAIN" >> "$GITHUB_OUTPUT"

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: ${{ steps.toolchain.outputs.version }}

      - name: Setup Namespace Cache
        uses: namespacelabs/nscloud-cache-action@446d8f390563cd54ca27e8de5bdb816f63c0b706 # v1.2.21
        with:
          cache: rust

      - name: Install Benchmarking Tools
        uses: taiki-e/install-action@7ea888af71a31437ad4e71c62d021b3bb2728ea9 # v2.49.3
        with:
          tool: cargo-criterion,critcmp

      - name: Benchmark Baseline
        working-directory: baseline
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Benchmarking baseline: ${{ github.event.inputs.regression_baseline }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          cargo bench --workspace -- --noplot --save-baseline baseline
        env:
          RUSTFLAGS: "-C target-cpu=native"

      - name: Benchmark Current
        working-directory: current
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Benchmarking current: ${{ github.sha }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          cargo bench --workspace -- --noplot --save-baseline current
        env:
          RUSTFLAGS: "-C target-cpu=native"

      - name: Compare Results
        working-directory: current
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Regression Analysis"
          echo "Baseline: ${{ github.event.inputs.regression_baseline }}"
          echo "Current:  ${{ github.sha }}"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          mkdir -p regression-results
          critcmp baseline current 2>&1 | tee regression-results/comparison.txt

          if grep -E "regressed|slower" regression-results/comparison.txt | grep -v "1\.[0-4][0-9]x"; then
            echo ""
            echo "Potential regressions detected (>5% slower)"
          else
            echo ""
            echo "No significant regressions detected"
          fi

      - name: Upload Regression Report
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: regression-report
          path: current/regression-results/
          retention-days: 90
