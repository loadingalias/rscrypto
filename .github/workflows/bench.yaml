name: Bench

on:
  workflow_dispatch:
    inputs:
      crates:
        description: "Crate(s), comma-separated (e.g. hashes). Empty = workspace."
        required: false
        type: string
      benches:
        description: "Bench target(s), comma-separated (e.g. blake3). Optional."
        required: false
        type: string
      run_amd_zen4:
        description: "AMD Zen4 (RunsOn)"
        required: false
        type: boolean
      run_intel_spr:
        description: "Intel Sapphire Rapids (RunsOn)"
        required: false
        type: boolean
      run_intel_icl:
        description: "Intel Ice Lake (RunsOn)"
        required: false
        type: boolean
      run_amd_zen5:
        description: "AMD Zen5 (RunsOn)"
        required: false
        type: boolean
      run_graviton3:
        description: "AWS Graviton3 (RunsOn)"
        required: false
        type: boolean
      run_graviton4:
        description: "AWS Graviton4 (RunsOn)"
        required: false
        type: boolean
      run_ibm_s390x:
        description: "IBM Z (s390x)"
        required: false
        type: boolean
      run_ibm_power10:
        description: "IBM POWER10 (ppc64le)"
        required: false
        type: boolean
      only:
        description: "Algorithm selector(s), comma-separated (e.g. blake3, crc32c)."
        required: false
        type: string
      quick:
        description: "Quick mode (Criterion --quick). Faster, noisier."
        required: false
        type: boolean
      warmup_ms:
        description: "Warmup override in ms (optional)."
        required: false
        type: string
      measure_ms:
        description: "Measurement override in ms (optional)."
        required: false
        type: string
      sample_size:
        description: "Sample size override (optional, >=10)."
        required: false
        type: string
      profile_time_secs:
        description: "Profile-time override in seconds (optional)."
        required: false
        type: string
      blake3_force_kernel:
        description: "Optional BLAKE3 forced kernel override (e.g. x86_64/avx512, aarch64/neon, s390x/vector, powerpc64/vsx)."
        required: false
        type: string
      filter:
        description: "Advanced raw Criterion filter(s), comma-separated."
        required: false
        type: string
      upload_raw_criterion:
        description: "Attach raw Criterion directory in artifact (large)."
        required: false
        type: boolean
        default: false
      allow_full_hashes_comp:
        description: "Allow unscoped hashes/comp runs (very expensive; may hit lane timeouts)."
        required: false
        type: boolean
        default: false
      enforce_blake3_gap_gate:
        description: "Fail when pinned BLAKE3 oneshot gap thresholds are exceeded (requires quick=false)."
        required: false
        type: boolean
        default: false
      enforce_blake3_kernel_gate:
        description: "Fail when best lane-native kernel-ab BLAKE3 gaps exceed platform thresholds (requires quick=false)."
        required: false
        type: boolean
        default: false

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_BENCH_MODE: ci
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-C target-cpu=native"

permissions:
  contents: read

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      has_targets: ${{ steps.plan.outputs.has_targets }}
      matrix: ${{ steps.plan.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 1

      - name: Build Lane Matrix
        id: plan
        shell: bash
        env:
          GH_RUN_ID: ${{ github.run_id }}
          RUN_AMD_ZEN4: ${{ inputs.run_amd_zen4 && 'true' || 'false' }}
          RUN_INTEL_SPR: ${{ inputs.run_intel_spr && 'true' || 'false' }}
          RUN_INTEL_ICL: ${{ inputs.run_intel_icl && 'true' || 'false' }}
          RUN_AMD_ZEN5: ${{ inputs.run_amd_zen5 && 'true' || 'false' }}
          RUN_GRAVITON3: ${{ inputs.run_graviton3 && 'true' || 'false' }}
          RUN_GRAVITON4: ${{ inputs.run_graviton4 && 'true' || 'false' }}
          RUN_IBM_S390X: ${{ inputs.run_ibm_s390x && 'true' || 'false' }}
          RUN_IBM_POWER10: ${{ inputs.run_ibm_power10 && 'true' || 'false' }}
        run: scripts/ci/emit-manual-matrix.sh bench

  bench:
    name: Benchmark (${{ matrix.display_name }})
    needs: plan
    if: ${{ needs.plan.outputs.has_targets == 'true' }}
    concurrency:
      # Allow multiple bench workflow runs to overlap as long as they target
      # different lanes; serialize per lane to avoid self-contention.
      group: bench-${{ github.ref }}-${{ matrix.platform }}
      cancel-in-progress: false
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.plan.outputs.matrix) }}
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ${{ matrix.runner }}
      timeout_minutes: ${{ matrix.timeout_minutes }}
      setup_kind: ${{ matrix.setup_kind }}
      cache_key: ${{ matrix.cache_key }}
      tools_mode: ${{ matrix.tools_mode }}
      toolchain_components: ${{ matrix.toolchain_components }}
      runson_mode: ${{ matrix.runson_mode }}
      pre_script: |
        echo "Bench host: ${{ matrix.platform }}"
        uname -a
        lscpu
        if [[ "${{ matrix.setup_kind }}" == "default" ]]; then
          cat /proc/cpuinfo | head -50
        fi
      run_script: |
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.crates }}" \
        BENCH_BENCHES="${{ inputs.benches }}" \
        BENCH_ONLY="${{ inputs.only }}" \
        BENCH_FILTER="${{ inputs.filter }}" \
        BENCH_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.profile_time_secs }}" \
        RSCRYPTO_BLAKE3_FORCE_KERNEL="${{ inputs.blake3_force_kernel }}" \
        BENCH_ATTACH_CRITERION=${{ inputs.upload_raw_criterion && 'true' || 'false' }} \
        BENCH_ALLOW_FULL_HASHES_COMP=${{ inputs.allow_full_hashes_comp && 'true' || 'false' }} \
        BENCH_ENFORCE_BLAKE3_GAP_GATE=${{ inputs.enforce_blake3_gap_gate && 'true' || 'false' }} \
        BENCH_ENFORCE_BLAKE3_KERNEL_GATE=${{ inputs.enforce_blake3_kernel_gate && 'true' || 'false' }} \
        BENCH_PLATFORM="${{ matrix.platform }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-${{ matrix.artifact_suffix }}
      artifact_path: benchmark-results/
