name: Bench

on:
  workflow_dispatch:
    inputs:
      run_amd_zen4:
        description: "Run benchmarks on AMD Zen4 (Namespace)"
        required: false
        type: boolean
        default: true
      run_intel_spr:
        description: "Run benchmarks on Intel Sapphire Rapids (RunsOn)"
        required: false
        type: boolean
        default: true
      run_intel_icl:
        description: "Run benchmarks on Intel Ice Lake (RunsOn)"
        required: false
        type: boolean
        default: false
      run_amd_zen5:
        description: "Run benchmarks on AMD Zen5 (RunsOn)"
        required: false
        type: boolean
        default: false
      run_graviton3:
        description: "Run benchmarks on AWS Graviton3 (RunsOn)"
        required: false
        type: boolean
        default: true
      run_graviton4:
        description: "Run benchmarks on AWS Graviton4 (RunsOn)"
        required: false
        type: boolean
        default: false
      run_ibm_s390x:
        description: "Run benchmarks on IBM Z (s390x)"
        required: false
        type: boolean
        default: false
      run_ibm_power10:
        description: "Run benchmarks on IBM POWER10 (ppc64le)"
        required: false
        type: boolean
        default: false
      crates:
        description: "Benchmark crates (comma-separated, empty = workspace)"
        required: false
        type: string
        default: ""
      benches:
        description: "Specific benches (comma-separated, optional)"
        required: false
        type: string
        default: ""
      only:
        description: "Algorithm selector(s), comma-separated (e.g. blake3, crc32c, crc64nvme)"
        required: false
        type: string
        default: ""
      filter:
        description: "Raw Criterion filter token(s), comma-separated (advanced)"
        required: false
        type: string
        default: ""
      quick:
        description: "Quick benchmark mode (Criterion --quick + shorter defaults)"
        required: false
        type: boolean
        default: false
      warmup_ms:
        description: "Warmup duration override in ms (optional)"
        required: false
        type: string
        default: ""
      measure_ms:
        description: "Measurement duration override in ms (optional)"
        required: false
        type: string
        default: ""
      sample_size:
        description: "Criterion sample size override (optional, >=10)"
        required: false
        type: string
        default: ""
      profile_time_secs:
        description: "Criterion profile-time override in seconds (optional)"
        required: false
        type: string
        default: ""

concurrency:
  group: manual-bench-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_BENCH_MODE: ci
  CARGO_INCREMENTAL: 0
  RUSTFLAGS: "-C target-cpu=native"

permissions:
  contents: read

jobs:
  bench-amd-zen4:
    name: Benchmark (AMD Zen4)
    if: inputs.run_amd_zen4
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: namespace-profile-rscrypto-linux-x86
      timeout_minutes: 360
      setup_kind: namespace
      run_script: |
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.crates }}" \
        BENCH_BENCHES="${{ inputs.benches }}" \
        BENCH_ONLY="${{ inputs.only }}" \
        BENCH_FILTER="${{ inputs.filter }}" \
        BENCH_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.profile_time_secs }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-amd-zen4
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-intel-spr:
    name: Benchmark (Intel Sapphire Rapids)
    if: inputs.run_intel_spr
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=intel-spr
      timeout_minutes: 360
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.crates }}" \
        BENCH_BENCHES="${{ inputs.benches }}" \
        BENCH_ONLY="${{ inputs.only }}" \
        BENCH_FILTER="${{ inputs.filter }}" \
        BENCH_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.profile_time_secs }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-intel-spr
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-intel-icl:
    name: Benchmark (Intel Ice Lake)
    if: inputs.run_intel_icl
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=intel-icl
      timeout_minutes: 360
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.crates }}" \
        BENCH_BENCHES="${{ inputs.benches }}" \
        BENCH_ONLY="${{ inputs.only }}" \
        BENCH_FILTER="${{ inputs.filter }}" \
        BENCH_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.profile_time_secs }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-intel-icl
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-amd-zen5:
    name: Benchmark (AMD Zen5)
    if: inputs.run_amd_zen5
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=amd-zen5
      timeout_minutes: 360
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.crates }}" \
        BENCH_BENCHES="${{ inputs.benches }}" \
        BENCH_ONLY="${{ inputs.only }}" \
        BENCH_FILTER="${{ inputs.filter }}" \
        BENCH_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.profile_time_secs }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-amd-zen5
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-graviton3:
    name: Benchmark (AWS Graviton3)
    if: inputs.run_graviton3
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=graviton3
      timeout_minutes: 360
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.crates }}" \
        BENCH_BENCHES="${{ inputs.benches }}" \
        BENCH_ONLY="${{ inputs.only }}" \
        BENCH_FILTER="${{ inputs.filter }}" \
        BENCH_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.profile_time_secs }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-graviton3
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-graviton4:
    name: Benchmark (AWS Graviton4)
    if: inputs.run_graviton4
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=graviton4
      timeout_minutes: 360
      setup_kind: runson
      runson_mode: runson-bench
      run_script: |
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.crates }}" \
        BENCH_BENCHES="${{ inputs.benches }}" \
        BENCH_ONLY="${{ inputs.only }}" \
        BENCH_FILTER="${{ inputs.filter }}" \
        BENCH_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.profile_time_secs }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-graviton4
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-ibm-s390x:
    name: Benchmark (IBM Z s390x)
    if: inputs.run_ibm_s390x
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-s390x
      timeout_minutes: 120
      setup_kind: default
      cache_key: manual-ibm-bench-s390x
      tools_mode: none
      toolchain_components: ""
      pre_script: |
        uname -a
        lscpu
        cat /proc/cpuinfo | head -50
      run_script: |
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.crates }}" \
        BENCH_BENCHES="${{ inputs.benches }}" \
        BENCH_ONLY="${{ inputs.only }}" \
        BENCH_FILTER="${{ inputs.filter }}" \
        BENCH_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.profile_time_secs }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-ibm-s390x
      artifact_path: |
        benchmark-results/
        target/criterion/

  bench-ibm-power10:
    name: Benchmark (IBM POWER10 ppc64le)
    if: inputs.run_ibm_power10
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-ppc64le-p10
      timeout_minutes: 120
      setup_kind: default
      cache_key: manual-ibm-bench-power10
      tools_mode: none
      toolchain_components: ""
      pre_script: |
        uname -a
        lscpu
        cat /proc/cpuinfo | head -50
      run_script: |
        BENCH_OUTPUT_DIR=benchmark-results \
        BENCH_CRATES="${{ inputs.crates }}" \
        BENCH_BENCHES="${{ inputs.benches }}" \
        BENCH_ONLY="${{ inputs.only }}" \
        BENCH_FILTER="${{ inputs.filter }}" \
        BENCH_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        BENCH_WARMUP_MS="${{ inputs.warmup_ms }}" \
        BENCH_MEASURE_MS="${{ inputs.measure_ms }}" \
        BENCH_SAMPLE_SIZE="${{ inputs.sample_size }}" \
        BENCH_PROFILE_TIME_SECS="${{ inputs.profile_time_secs }}" \
        scripts/ci/run-bench.sh
      artifact_name: benchmark-ibm-power10
      artifact_path: |
        benchmark-results/
        target/criterion/
