name: Tune

on:
  workflow_dispatch:
    inputs:
      crates:
        description: "Crate(s) to tune (comma-separated, leave empty for all)"
        required: false
        type: string
        default: "checksum,hashes"
      run_amd_zen4:
        description: "Run tune on AMD Zen4 (Namespace)"
        required: false
        type: boolean
        default: true
      run_intel_spr:
        description: "Run tune on Intel Sapphire Rapids (RunsOn)"
        required: false
        type: boolean
        default: true
      run_intel_icl:
        description: "Run tune on Intel Ice Lake (RunsOn)"
        required: false
        type: boolean
        default: false
      run_amd_zen5:
        description: "Run tune on AMD Zen5 (RunsOn)"
        required: false
        type: boolean
        default: false
      run_graviton3:
        description: "Run tune on AWS Graviton3 (RunsOn)"
        required: false
        type: boolean
        default: true
      run_graviton4:
        description: "Run tune on AWS Graviton4 (RunsOn)"
        required: false
        type: boolean
        default: false
      run_ibm_s390x:
        description: "Run tune on IBM Z (s390x)"
        required: false
        type: boolean
        default: false
      run_ibm_power10:
        description: "Run tune on IBM POWER10 (ppc64le)"
        required: false
        type: boolean
        default: false
      only:
        description: "Algorithm selector(s), comma-separated (e.g. blake3, crc64nvme)"
        required: false
        type: string
        default: ""
      quick:
        description: "Quick developer preview only (faster, noisier; never for dispatch apply)"
        required: false
        type: boolean
        default: false
      apply:
        description: "Apply tuning output into dispatch tables and emit patch artifact"
        required: false
        type: boolean
        default: false
      warmup_ms:
        description: "Global warmup duration override in ms (optional)"
        required: false
        type: string
        default: ""
      measure_ms:
        description: "Global measurement duration override in ms (optional)"
        required: false
        type: string
        default: ""
      checksum_warmup_ms:
        description: "Checksum-only warmup override in ms (optional)"
        required: false
        type: string
        default: ""
      checksum_measure_ms:
        description: "Checksum-only measurement override in ms (optional)"
        required: false
        type: string
        default: ""
      hash_warmup_ms:
        description: "Hash-only warmup override in ms (optional)"
        required: false
        type: string
        default: ""
      hash_measure_ms:
        description: "Hash-only measurement override in ms (optional)"
        required: false
        type: string
        default: ""
      repeats:
        description: "Measurement repeats per platform lane (default: 1)"
        required: false
        type: string
        default: ""
      aggregation:
        description: "Repeated-run aggregation mode (auto, median, trimmed-mean)"
        required: false
        type: string
        default: "auto"

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_TUNE_MODE: ci
  CARGO_INCREMENTAL: 0

permissions:
  contents: read

jobs:
  tune-amd-zen4:
    if: inputs.run_amd_zen4
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: namespace-profile-rscrypto-linux-x86
      timeout_minutes: 360
      setup_kind: namespace
      pre_script: |
        echo "Tune host: amd-zen4"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        TUNE_CRATES="${{ inputs.crates }}" \
        TUNE_ONLY="${{ inputs.only }}" \
        TUNE_APPLY=${{ inputs.apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=false \
        TUNE_ENFORCE_TARGETS=false \
        TUNE_WARMUP_MS="${{ inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.measure_ms }}" \
        TUNE_CHECKSUM_WARMUP_MS="${{ inputs.checksum_warmup_ms }}" \
        TUNE_CHECKSUM_MEASURE_MS="${{ inputs.checksum_measure_ms }}" \
        TUNE_HASH_WARMUP_MS="${{ inputs.hash_warmup_ms }}" \
        TUNE_HASH_MEASURE_MS="${{ inputs.hash_measure_ms }}" \
        TUNE_REPEATS="${{ inputs.repeats }}" \
        TUNE_AGGREGATION="${{ inputs.aggregation }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-amd-zen4
      artifact_path: tune-results/

  tune-intel-spr:
    if: inputs.run_intel_spr
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=intel-spr
      timeout_minutes: 360
      setup_kind: runson
      runson_mode: runson-bench
      pre_script: |
        echo "Tune host: intel-spr"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        TUNE_CRATES="${{ inputs.crates }}" \
        TUNE_ONLY="${{ inputs.only }}" \
        TUNE_APPLY=${{ inputs.apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=false \
        TUNE_ENFORCE_TARGETS=false \
        TUNE_WARMUP_MS="${{ inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.measure_ms }}" \
        TUNE_CHECKSUM_WARMUP_MS="${{ inputs.checksum_warmup_ms }}" \
        TUNE_CHECKSUM_MEASURE_MS="${{ inputs.checksum_measure_ms }}" \
        TUNE_HASH_WARMUP_MS="${{ inputs.hash_warmup_ms }}" \
        TUNE_HASH_MEASURE_MS="${{ inputs.hash_measure_ms }}" \
        TUNE_REPEATS="${{ inputs.repeats }}" \
        TUNE_AGGREGATION="${{ inputs.aggregation }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-intel-spr
      artifact_path: tune-results/

  tune-intel-icl:
    if: inputs.run_intel_icl
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=intel-icl
      timeout_minutes: 360
      setup_kind: runson
      runson_mode: runson-bench
      pre_script: |
        echo "Tune host: intel-icl"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        TUNE_CRATES="${{ inputs.crates }}" \
        TUNE_ONLY="${{ inputs.only }}" \
        TUNE_APPLY=${{ inputs.apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=false \
        TUNE_ENFORCE_TARGETS=false \
        TUNE_WARMUP_MS="${{ inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.measure_ms }}" \
        TUNE_CHECKSUM_WARMUP_MS="${{ inputs.checksum_warmup_ms }}" \
        TUNE_CHECKSUM_MEASURE_MS="${{ inputs.checksum_measure_ms }}" \
        TUNE_HASH_WARMUP_MS="${{ inputs.hash_warmup_ms }}" \
        TUNE_HASH_MEASURE_MS="${{ inputs.hash_measure_ms }}" \
        TUNE_REPEATS="${{ inputs.repeats }}" \
        TUNE_AGGREGATION="${{ inputs.aggregation }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-intel-icl
      artifact_path: tune-results/

  tune-amd-zen5:
    if: inputs.run_amd_zen5
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=amd-zen5
      timeout_minutes: 360
      setup_kind: runson
      runson_mode: runson-bench
      pre_script: |
        echo "Tune host: amd-zen5"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        TUNE_CRATES="${{ inputs.crates }}" \
        TUNE_ONLY="${{ inputs.only }}" \
        TUNE_APPLY=${{ inputs.apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=false \
        TUNE_ENFORCE_TARGETS=false \
        TUNE_WARMUP_MS="${{ inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.measure_ms }}" \
        TUNE_CHECKSUM_WARMUP_MS="${{ inputs.checksum_warmup_ms }}" \
        TUNE_CHECKSUM_MEASURE_MS="${{ inputs.checksum_measure_ms }}" \
        TUNE_HASH_WARMUP_MS="${{ inputs.hash_warmup_ms }}" \
        TUNE_HASH_MEASURE_MS="${{ inputs.hash_measure_ms }}" \
        TUNE_REPEATS="${{ inputs.repeats }}" \
        TUNE_AGGREGATION="${{ inputs.aggregation }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-amd-zen5
      artifact_path: tune-results/

  tune-graviton3:
    if: inputs.run_graviton3
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=graviton3
      timeout_minutes: 360
      setup_kind: runson
      runson_mode: runson-bench
      pre_script: |
        echo "Tune host: graviton3"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        TUNE_CRATES="${{ inputs.crates }}" \
        TUNE_ONLY="${{ inputs.only }}" \
        TUNE_APPLY=${{ inputs.apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=false \
        TUNE_ENFORCE_TARGETS=false \
        TUNE_WARMUP_MS="${{ inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.measure_ms }}" \
        TUNE_CHECKSUM_WARMUP_MS="${{ inputs.checksum_warmup_ms }}" \
        TUNE_CHECKSUM_MEASURE_MS="${{ inputs.checksum_measure_ms }}" \
        TUNE_HASH_WARMUP_MS="${{ inputs.hash_warmup_ms }}" \
        TUNE_HASH_MEASURE_MS="${{ inputs.hash_measure_ms }}" \
        TUNE_REPEATS="${{ inputs.repeats }}" \
        TUNE_AGGREGATION="${{ inputs.aggregation }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-graviton3
      artifact_path: tune-results/

  tune-graviton4:
    if: inputs.run_graviton4
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=graviton4
      timeout_minutes: 360
      setup_kind: runson
      runson_mode: runson-bench
      pre_script: |
        echo "Tune host: graviton4"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        TUNE_CRATES="${{ inputs.crates }}" \
        TUNE_ONLY="${{ inputs.only }}" \
        TUNE_APPLY=${{ inputs.apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=false \
        TUNE_ENFORCE_TARGETS=false \
        TUNE_WARMUP_MS="${{ inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.measure_ms }}" \
        TUNE_CHECKSUM_WARMUP_MS="${{ inputs.checksum_warmup_ms }}" \
        TUNE_CHECKSUM_MEASURE_MS="${{ inputs.checksum_measure_ms }}" \
        TUNE_HASH_WARMUP_MS="${{ inputs.hash_warmup_ms }}" \
        TUNE_HASH_MEASURE_MS="${{ inputs.hash_measure_ms }}" \
        TUNE_REPEATS="${{ inputs.repeats }}" \
        TUNE_AGGREGATION="${{ inputs.aggregation }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-graviton4
      artifact_path: tune-results/

  tune-ibm-s390x:
    if: inputs.run_ibm_s390x
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-s390x
      timeout_minutes: 120
      setup_kind: default
      cache_key: manual-ibm-tune-s390x
      tools_mode: none
      toolchain_components: ""
      pre_script: |
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        TUNE_CRATES="${{ inputs.crates }}" \
        TUNE_ONLY="${{ inputs.only }}" \
        TUNE_APPLY=${{ inputs.apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=false \
        TUNE_ENFORCE_TARGETS=false \
        TUNE_WARMUP_MS="${{ inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.measure_ms }}" \
        TUNE_CHECKSUM_WARMUP_MS="${{ inputs.checksum_warmup_ms }}" \
        TUNE_CHECKSUM_MEASURE_MS="${{ inputs.checksum_measure_ms }}" \
        TUNE_HASH_WARMUP_MS="${{ inputs.hash_warmup_ms }}" \
        TUNE_HASH_MEASURE_MS="${{ inputs.hash_measure_ms }}" \
        TUNE_REPEATS="${{ inputs.repeats }}" \
        TUNE_AGGREGATION="${{ inputs.aggregation }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-ibm-s390x
      artifact_path: tune-results/

  tune-ibm-power10:
    if: inputs.run_ibm_power10
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-24.04-ppc64le-p10
      timeout_minutes: 120
      setup_kind: default
      cache_key: manual-ibm-tune-power10
      tools_mode: none
      toolchain_components: ""
      pre_script: |
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        TUNE_CRATES="${{ inputs.crates }}" \
        TUNE_ONLY="${{ inputs.only }}" \
        TUNE_APPLY=${{ inputs.apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=false \
        TUNE_ENFORCE_TARGETS=false \
        TUNE_WARMUP_MS="${{ inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.measure_ms }}" \
        TUNE_CHECKSUM_WARMUP_MS="${{ inputs.checksum_warmup_ms }}" \
        TUNE_CHECKSUM_MEASURE_MS="${{ inputs.checksum_measure_ms }}" \
        TUNE_HASH_WARMUP_MS="${{ inputs.hash_warmup_ms }}" \
        TUNE_HASH_MEASURE_MS="${{ inputs.hash_measure_ms }}" \
        TUNE_REPEATS="${{ inputs.repeats }}" \
        TUNE_AGGREGATION="${{ inputs.aggregation }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-ibm-power10
      artifact_path: tune-results/
