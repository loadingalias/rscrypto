name: Tune

on:
  workflow_dispatch:
    inputs:
      run_amd_zen4:
        description: "AMD Zen4 (RunsOn)"
        required: false
        type: boolean
      run_intel_spr:
        description: "Intel Sapphire Rapids (RunsOn)"
        required: false
        type: boolean
      run_intel_icl:
        description: "Intel Ice Lake (RunsOn)"
        required: false
        type: boolean
      run_amd_zen5:
        description: "AMD Zen5 (RunsOn)"
        required: false
        type: boolean
      run_graviton3:
        description: "AWS Graviton3 (RunsOn)"
        required: false
        type: boolean
      run_graviton4:
        description: "AWS Graviton4 (RunsOn)"
        required: false
        type: boolean
      run_ibm_s390x:
        description: "IBM Z (s390x)"
        required: false
        type: boolean
      run_ibm_power10:
        description: "IBM POWER10 (ppc64le)"
        required: false
        type: boolean
      only:
        description: "Optional override selector(s). If set, overrides slice."
        required: false
        type: string
        default: ""
      slice:
        description: "BLAKE3 tuning slice."
        required: false
        type: choice
        default: "core"
        options:
          - core
          - strict
          - informational
          - all
      quick:
        description: "Quick mode. Faster, noisier. Not for final dispatch decisions."
        required: false
        type: boolean
      preset:
        description: "Execution preset: boundary-first (discovery), full-tune (measure+derive), apply (apply tuned tables), custom (use toggles below)."
        required: false
        type: choice
        default: "boundary-first"
        options:
          - boundary-first
          - full-tune
          - apply
          - custom
      self_check:
        description: "Run post-derive self checks."
        required: false
        type: boolean
      enforce_targets:
        description: "Enforce baseline/target parity checks."
        required: false
        type: boolean
      apply:
        description: "Apply output to dispatch tables and emit patch artifact."
        required: false
        type: boolean
      run_blake3_boundary:
        description: "Capture BLAKE3 boundary CSVs (auto + forced kernels) and summary."
        required: false
        type: boolean
        default: true
      boundary_only:
        description: "Run only BLAKE3 boundary capture (skip rscrypto-tune). Used only with preset=custom."
        required: false
        type: boolean
        default: true
      max_parallel:
        description: "Maximum tune lanes in flight at once (cost guardrail)."
        required: false
        type: string
        default: "2"
      boundary_warmup_ms:
        description: "Boundary runner warmup override in ms (optional)."
        required: false
        type: string
      boundary_measure_ms:
        description: "Boundary runner measurement override in ms (optional)."
        required: false
        type: string
      repeats:
        description: "Measurement repeats per lane (e.g. 3). Default: 1."
        required: false
        type: string
      aggregation:
        description: "Repeat aggregation: auto | median | trimmed-mean."
        required: false
        type: string
      warmup_ms:
        description: "Global warmup override in ms (optional)."
        required: false
        type: string
      measure_ms:
        description: "Global measurement override in ms (optional)."
        required: false
        type: string

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_TUNE_MODE: ci
  CARGO_INCREMENTAL: 0

permissions:
  contents: read

concurrency:
  group: manual-tune-${{ github.ref }}
  cancel-in-progress: true

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      has_targets: ${{ steps.plan.outputs.has_targets }}
      matrix: ${{ steps.plan.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 1

      - name: Build Lane Matrix
        id: plan
        shell: bash
        env:
          GH_RUN_ID: ${{ github.run_id }}
          RUN_AMD_ZEN4: ${{ inputs.run_amd_zen4 && 'true' || 'false' }}
          RUN_INTEL_SPR: ${{ inputs.run_intel_spr && 'true' || 'false' }}
          RUN_INTEL_ICL: ${{ inputs.run_intel_icl && 'true' || 'false' }}
          RUN_AMD_ZEN5: ${{ inputs.run_amd_zen5 && 'true' || 'false' }}
          RUN_GRAVITON3: ${{ inputs.run_graviton3 && 'true' || 'false' }}
          RUN_GRAVITON4: ${{ inputs.run_graviton4 && 'true' || 'false' }}
          RUN_IBM_S390X: ${{ inputs.run_ibm_s390x && 'true' || 'false' }}
          RUN_IBM_POWER10: ${{ inputs.run_ibm_power10 && 'true' || 'false' }}
        run: scripts/ci/emit-manual-matrix.sh tune

  tune:
    name: Tune (${{ matrix.display_name }})
    needs: plan
    if: ${{ needs.plan.outputs.has_targets == 'true' }}
    strategy:
      fail-fast: false
      max-parallel: ${{ fromJSON(inputs.max_parallel) }}
      matrix:
        include: ${{ fromJSON(needs.plan.outputs.matrix) }}
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ${{ matrix.runner }}
      timeout_minutes: ${{ matrix.timeout_minutes }}
      setup_kind: ${{ matrix.setup_kind }}
      cache_key: ${{ matrix.cache_key }}
      tools_mode: ${{ matrix.tools_mode }}
      toolchain_components: ${{ matrix.toolchain_components }}
      runson_mode: ${{ matrix.runson_mode }}
      pre_script: |
        echo "Tune host: ${{ matrix.platform }}"
        uname -a
        lscpu
      run_script: |
        TUNE_PRESET="${{ inputs.preset }}" \
        TUNE_SLICE="${{ inputs.slice }}" \
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ inputs.quick && 'true' || 'false' }} \
        TUNE_CRATES="hashes" \
        TUNE_ONLY="${{ inputs.only }}" \
        TUNE_APPLY=${{ inputs.apply && 'true' || 'false' }} \
        TUNE_SELF_CHECK=${{ inputs.self_check && 'true' || 'false' }} \
        TUNE_ENFORCE_TARGETS=${{ inputs.enforce_targets && 'true' || 'false' }} \
        TUNE_BLAKE3_BOUNDARY=${{ inputs.run_blake3_boundary && 'true' || 'false' }} \
        TUNE_BOUNDARY_ONLY=${{ inputs.boundary_only && 'true' || 'false' }} \
        TUNE_BOUNDARY_WARMUP_MS="${{ inputs.boundary_warmup_ms }}" \
        TUNE_BOUNDARY_MEASURE_MS="${{ inputs.boundary_measure_ms }}" \
        TUNE_WARMUP_MS="${{ inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ inputs.measure_ms }}" \
        TUNE_CARGO_BUILD_JOBS=4 \
        TUNE_REPEATS="${{ inputs.repeats }}" \
        TUNE_AGGREGATION="${{ inputs.aggregation }}" \
        bash -euo pipefail -c '
          if [[ -z "${TUNE_ONLY:-}" ]]; then
            case "${TUNE_SLICE:-core}" in
              core)
                TUNE_ONLY="blake3,blake3-latency,blake3-chunk,blake3-stream4k"
                ;;
              strict)
                TUNE_ONLY="blake3-latency-keyed,blake3-latency-derive,blake3-latency-xof,blake3-stream4k-keyed,blake3-stream4k-derive,blake3-stream4k-xof"
                ;;
              informational)
                TUNE_ONLY="blake3-keyed,blake3-derive,blake3-parent,blake3-parent-fold,blake3-stream64,blake3-stream256,blake3-stream1k,blake3-stream-mixed,blake3-stream64-keyed,blake3-stream64-derive,blake3-stream64-xof,blake3-stream-mixed-xof"
                ;;
              all)
                TUNE_ONLY="blake3"
                ;;
              *)
                echo "error: unknown slice: ${TUNE_SLICE}" >&2
                exit 2
                ;;
            esac
          fi
          export TUNE_ONLY
          case "${TUNE_PRESET:-boundary-first}" in
            boundary-first)
              TUNE_APPLY=false
              TUNE_SELF_CHECK=false
              TUNE_ENFORCE_TARGETS=false
              TUNE_BLAKE3_BOUNDARY=true
              TUNE_BOUNDARY_ONLY=true
              ;;
            full-tune)
              TUNE_APPLY=false
              TUNE_SELF_CHECK=false
              TUNE_ENFORCE_TARGETS=false
              TUNE_BLAKE3_BOUNDARY=true
              TUNE_BOUNDARY_ONLY=false
              ;;
            apply)
              TUNE_APPLY=true
              TUNE_SELF_CHECK=true
              TUNE_ENFORCE_TARGETS=true
              TUNE_BLAKE3_BOUNDARY=false
              TUNE_BOUNDARY_ONLY=false
              ;;
            custom)
              ;;
            *)
              echo "error: unknown preset: ${TUNE_PRESET}" >&2
              exit 2
              ;;
          esac
          export TUNE_APPLY TUNE_SELF_CHECK TUNE_ENFORCE_TARGETS TUNE_BLAKE3_BOUNDARY TUNE_BOUNDARY_ONLY
          scripts/ci/run-tune.sh
        '
      artifact_name: tuning-${{ matrix.artifact_suffix }}
      artifact_path: tune-results/
