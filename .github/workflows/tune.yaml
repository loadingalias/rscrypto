name: Tune

on:
  workflow_dispatch:
    inputs:
      crates:
        description: "Crate(s) to tune (comma-separated, leave empty for all)"
        required: false
        type: string
        default: "checksum,hashes"
      run_intel:
        description: "Run on Intel (Granite/Emerald/Sapphire Rapids)"
        required: false
        type: boolean
        default: true
      run_intel_icl:
        description: "Run on Intel Ice Lake"
        required: false
        type: boolean
        default: false
      run_amd_zen4:
        description: "Run on AMD Zen4 (Namespace)"
        required: false
        type: boolean
        default: true
      run_amd_zen5:
        description: "Run on AMD Zen5 (RunsOn)"
        required: false
        type: boolean
        default: false
      run_graviton:
        description: "Run on Graviton (RunsOn)"
        required: false
        type: boolean
        default: true
      only:
        description: "Tune only specific algorithms (comma-separated, optional)"
        required: false
        type: string
        default: ""
      quick:
        description: "Quick mode (faster, noisier)"
        required: false
        type: boolean
        default: true
      apply:
        description: "Apply tuning output into dispatch tables and emit patch artifact"
        required: false
        type: boolean
        default: false
      self_check:
        description: "Run tuner self-check before success"
        required: false
        type: boolean
        default: false
      enforce_targets:
        description: "Fail run if any defined perf target is missed"
        required: false
        type: boolean
        default: false
      warmup_ms:
        description: "Custom warmup duration in ms (optional)"
        required: false
        type: string
        default: ""
      measure_ms:
        description: "Custom measure duration in ms (optional)"
        required: false
        type: string
        default: ""

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_TUNE_MODE: ci
  CARGO_INCREMENTAL: 0

permissions:
  contents: read

jobs:
  tune-intel:
    if: github.event.inputs.run_intel == 'true'
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=intel-bench
      timeout_minutes: 60
      setup_kind: runson
      runson_mode: runson-bench
      pre_script: |
        echo "Tune host: intel"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ github.event.inputs.quick }} \
        TUNE_CRATES="${{ github.event.inputs.crates }}" \
        TUNE_ONLY="${{ github.event.inputs.only }}" \
        TUNE_APPLY=${{ github.event.inputs.apply }} \
        TUNE_SELF_CHECK=${{ github.event.inputs.self_check }} \
        TUNE_ENFORCE_TARGETS=${{ github.event.inputs.enforce_targets }} \
        TUNE_WARMUP_MS="${{ github.event.inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ github.event.inputs.measure_ms }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-intel
      artifact_path: tune-results/

  tune-intel-icl:
    if: github.event.inputs.run_intel_icl == 'true'
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=intel-icl-bench
      timeout_minutes: 60
      setup_kind: runson
      runson_mode: runson-bench
      pre_script: |
        echo "Tune host: intel-icl"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ github.event.inputs.quick }} \
        TUNE_CRATES="${{ github.event.inputs.crates }}" \
        TUNE_ONLY="${{ github.event.inputs.only }}" \
        TUNE_APPLY=${{ github.event.inputs.apply }} \
        TUNE_SELF_CHECK=${{ github.event.inputs.self_check }} \
        TUNE_ENFORCE_TARGETS=${{ github.event.inputs.enforce_targets }} \
        TUNE_WARMUP_MS="${{ github.event.inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ github.event.inputs.measure_ms }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-intel-icl
      artifact_path: tune-results/

  tune-amd-zen4:
    if: github.event.inputs.run_amd_zen4 == 'true'
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: namespace-profile-rscrypto-linux-x86
      timeout_minutes: 60
      setup_kind: namespace
      pre_script: |
        echo "Tune host: amd-zen4"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ github.event.inputs.quick }} \
        TUNE_CRATES="${{ github.event.inputs.crates }}" \
        TUNE_ONLY="${{ github.event.inputs.only }}" \
        TUNE_APPLY=${{ github.event.inputs.apply }} \
        TUNE_SELF_CHECK=${{ github.event.inputs.self_check }} \
        TUNE_ENFORCE_TARGETS=${{ github.event.inputs.enforce_targets }} \
        TUNE_WARMUP_MS="${{ github.event.inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ github.event.inputs.measure_ms }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-amd-zen4
      artifact_path: tune-results/

  tune-amd-zen5:
    if: github.event.inputs.run_amd_zen5 == 'true'
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=amd-zen5
      timeout_minutes: 60
      setup_kind: runson
      runson_mode: runson-bench
      pre_script: |
        echo "Tune host: amd-zen5"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ github.event.inputs.quick }} \
        TUNE_CRATES="${{ github.event.inputs.crates }}" \
        TUNE_ONLY="${{ github.event.inputs.only }}" \
        TUNE_APPLY=${{ github.event.inputs.apply }} \
        TUNE_SELF_CHECK=${{ github.event.inputs.self_check }} \
        TUNE_ENFORCE_TARGETS=${{ github.event.inputs.enforce_targets }} \
        TUNE_WARMUP_MS="${{ github.event.inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ github.event.inputs.measure_ms }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-amd-zen5
      artifact_path: tune-results/

  tune-graviton:
    if: github.event.inputs.run_graviton == 'true'
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: runs-on=${{ github.run_id }}/runner=graviton
      timeout_minutes: 60
      setup_kind: runson
      runson_mode: runson-bench
      pre_script: |
        echo "Tune host: graviton"
        uname -a
        lscpu
      run_script: |
        TUNE_OUTPUT_DIR=tune-results \
        TUNE_QUICK=${{ github.event.inputs.quick }} \
        TUNE_CRATES="${{ github.event.inputs.crates }}" \
        TUNE_ONLY="${{ github.event.inputs.only }}" \
        TUNE_APPLY=${{ github.event.inputs.apply }} \
        TUNE_SELF_CHECK=${{ github.event.inputs.self_check }} \
        TUNE_ENFORCE_TARGETS=${{ github.event.inputs.enforce_targets }} \
        TUNE_WARMUP_MS="${{ github.event.inputs.warmup_ms }}" \
        TUNE_MEASURE_MS="${{ github.event.inputs.measure_ms }}" \
        scripts/ci/run-tune.sh
      artifact_name: tuning-graviton
      artifact_path: tune-results/
