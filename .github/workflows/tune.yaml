name: Tune

on:
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      crates:
        description: "Crate(s) to tune (comma-separated, leave empty for all)"
        required: false
        type: string
        default: "checksum,hashes"

      # ─────────────────────────────────────────────────────────────────────────
      # Intel x86-64 (RunsOn: Granite/Emerald/Sapphire Rapids, Ice Lake)
      # ─────────────────────────────────────────────────────────────────────────
      run_intel:
        description: "Run on Intel (Granite/Emerald/Sapphire Rapids)"
        required: false
        type: boolean
        default: true
      run_intel_icl:
        description: "Run on Intel Ice Lake (c6i/m6i - 3rd Gen Xeon)"
        required: false
        type: boolean
        default: false

      # ─────────────────────────────────────────────────────────────────────────
      # AMD x86-64 (Namespace: Zen4, RunsOn: Zen5)
      # ─────────────────────────────────────────────────────────────────────────
      run_amd_zen4:
        description: "Run on AMD Zen4 (Namespace)"
        required: false
        type: boolean
        default: true
      run_amd_zen5:
        description: "Run on AMD Zen5 Turin (RunsOn)"
        required: false
        type: boolean
        default: false

      # ─────────────────────────────────────────────────────────────────────────
      # ARM64 Graviton (RunsOn)
      # ─────────────────────────────────────────────────────────────────────────
      run_graviton:
        description: "Run on Graviton (Neoverse V2/V1, RunsOn)"
        required: false
        type: boolean
        default: true

      # ─────────────────────────────────────────────────────────────────────────
      # IBM Z / POWER (ActionsPZ - Manual Only)
      # ─────────────────────────────────────────────────────────────────────────
      run_ibm_s390x:
        description: "Run on IBM Z (s390x, ActionsPZ)"
        required: false
        type: boolean
        default: false
      run_ibm_power9:
        description: "Run on IBM POWER9 (ppc64le, ActionsPZ)"
        required: false
        type: boolean
        default: false
      run_ibm_power10:
        description: "Run on IBM POWER10 (ppc64le, ActionsPZ)"
        required: false
        type: boolean
        default: false

      only:
        description: "Tune only specific algorithms (comma-separated, optional)"
        required: false
        type: string
        default: ""
      quick:
        description: "Quick mode (faster, noisier)"
        required: false
        type: boolean
        default: true
      apply:
        description: "Apply tuning output into dispatch tables and emit patch artifact"
        required: false
        type: boolean
        default: false
      self_check:
        description: "Run tuner self-check before success"
        required: false
        type: boolean
        default: false
      enforce_targets:
        description: "Fail run if any defined perf target is missed"
        required: false
        type: boolean
        default: false
      warmup_ms:
        description: "Custom warmup duration in ms (optional)"
        required: false
        type: string
        default: ""
      measure_ms:
        description: "Custom measure duration in ms (optional)"
        required: false
        type: string
        default: ""

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  RSCRYPTO_TUNE_MODE: ci
  CARGO_INCREMENTAL: 0

permissions:
  contents: read

jobs:
  tune:
    name: Tune (${{ matrix.target }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: intel
            runner_type: runson
            runner_id: intel-bench
            setup: runson
            timeout: 60
          - target: intel-icl
            runner_type: runson
            runner_id: intel-icl-bench
            setup: runson
            timeout: 60
          - target: amd-zen4
            runner_type: standard
            runner: namespace-profile-rscrypto-linux-x86
            setup: namespace
            timeout: 60
          - target: amd-zen5
            runner_type: runson
            runner_id: amd-zen5
            setup: runson
            timeout: 60
          - target: graviton
            runner_type: runson
            runner_id: graviton
            setup: runson
            timeout: 60
          - target: ibm-s390x
            runner_type: standard
            runner: ubuntu-24.04-s390x
            setup: default
            timeout: 90
          - target: ibm-power9
            runner_type: standard
            runner: ubuntu-24.04-ppc64le
            setup: default
            timeout: 90
          - target: ibm-power10
            runner_type: standard
            runner: ubuntu-24.04-ppc64le-p10
            setup: default
            timeout: 90
    runs-on: ${{ matrix.runner_type == 'runson' && format('runs-on={0}/runner={1}', github.run_id, matrix.runner_id) || matrix.runner }}
    timeout-minutes: ${{ matrix.timeout }}
    steps:
      - name: Determine Target Selection
        id: target
        run: |
          enabled=false
          case "${{ matrix.target }}" in
            intel) enabled="${{ github.event.inputs.run_intel }}" ;;
            intel-icl) enabled="${{ github.event.inputs.run_intel_icl }}" ;;
            amd-zen4) enabled="${{ github.event.inputs.run_amd_zen4 }}" ;;
            amd-zen5) enabled="${{ github.event.inputs.run_amd_zen5 }}" ;;
            graviton) enabled="${{ github.event.inputs.run_graviton }}" ;;
            ibm-s390x) enabled="${{ github.event.inputs.run_ibm_s390x }}" ;;
            ibm-power9) enabled="${{ github.event.inputs.run_ibm_power9 }}" ;;
            ibm-power10) enabled="${{ github.event.inputs.run_ibm_power10 }}" ;;
          esac
          echo "enabled=$enabled" >> "$GITHUB_OUTPUT"
          if [ "$enabled" != "true" ]; then
            echo "Skipping tune on target '${{ matrix.target }}' (manual toggle disabled)."
          fi

      - name: Checkout
        if: steps.target.outputs.enabled == 'true'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup RunsOn
        if: steps.target.outputs.enabled == 'true' && matrix.setup == 'runson'
        uses: ./.github/actions/setup-runson
        with:
          mode: runson-bench

      - name: Setup Namespace
        if: steps.target.outputs.enabled == 'true' && matrix.setup == 'namespace'
        uses: ./.github/actions/setup-namespace

      - name: Setup Host Toolchain
        if: steps.target.outputs.enabled == 'true' && matrix.setup == 'default'
        uses: ./.github/actions/setup
        with:
          cache-key: tune-${{ matrix.target }}
          tools-mode: none
          toolchain-components: ""

      - name: Record Host Details
        if: steps.target.outputs.enabled == 'true'
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Tune host: ${{ matrix.target }}"
          uname -a || true
          lscpu || true
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Run Unified Tuning
        if: steps.target.outputs.enabled == 'true'
        env:
          TUNE_OUTPUT_DIR: tune-results
          TUNE_QUICK: ${{ github.event.inputs.quick }}
          TUNE_CRATES: ${{ github.event.inputs.crates }}
          TUNE_ONLY: ${{ github.event.inputs.only }}
          TUNE_APPLY: ${{ github.event.inputs.apply }}
          TUNE_SELF_CHECK: ${{ github.event.inputs.self_check }}
          TUNE_ENFORCE_TARGETS: ${{ github.event.inputs.enforce_targets }}
          TUNE_WARMUP_MS: ${{ github.event.inputs.warmup_ms }}
          TUNE_MEASURE_MS: ${{ github.event.inputs.measure_ms }}
        run: scripts/ci/run-tune.sh

      - name: Upload Tuning Results
        if: always() && steps.target.outputs.enabled == 'true'
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: tuning-${{ matrix.target }}
          path: tune-results/
          retention-days: 90
