name: full-main

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: full-main-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

permissions:
  contents: read

jobs:
  lane-contract:
    name: Lane Contract (full-main)
    runs-on: ubuntu-latest
    steps:
      - name: Assert lane
        run: |
          test "${{ github.event_name }}" = "push" -o "${{ github.event_name }}" = "workflow_dispatch"
          echo "lane=full-main"

  ci:
    name: CI (${{ matrix.target.name }})
    needs: lane-contract
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
          - name: aarch64-unknown-linux-gnu
            runner: ubuntu-24.04-arm
          - name: x86_64-pc-windows-msvc
            runner: windows-latest
          - name: aarch64-pc-windows-msvc
            runner: windows-11-arm
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ${{ matrix.target.runner }}
      timeout_minutes: 35
      setup_kind: default
      cache_key: full-main-${{ matrix.target.name }}
      tools_mode: standard
      run_script: |
        just ci-check
        just build
        just test

  no-std:
    name: no_std (${{ matrix.target }})
    needs: lane-contract
    strategy:
      fail-fast: false
      matrix:
        target:
          - thumbv6m-none-eabi
          - riscv32imac-unknown-none-elf
          - aarch64-unknown-none
          - x86_64-unknown-none
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-latest
      timeout_minutes: 20
      setup_kind: default
      cache_key: full-main-no-std-${{ matrix.target }}
      tools_mode: minimal
      run_script: |
        rustup target add ${{ matrix.target }}
        cargo check -p platform -p traits -p backend --target ${{ matrix.target }} --no-default-features --lib
        cargo check -p platform -p traits -p backend --target ${{ matrix.target }} --no-default-features --features alloc --lib
        cargo build -p platform -p traits -p backend --target ${{ matrix.target }} --no-default-features --lib --release
        cargo build -p platform -p traits -p backend --target ${{ matrix.target }} --no-default-features --features alloc --lib --release

  wasm:
    name: wasm (${{ matrix.target }})
    needs: lane-contract
    strategy:
      fail-fast: false
      matrix:
        target:
          - wasm32-unknown-unknown
          - wasm32-wasip1
    uses: ./.github/workflows/_rust-job.yaml
    with:
      runner: ubuntu-latest
      timeout_minutes: 20
      setup_kind: default
      cache_key: full-main-wasm-${{ matrix.target }}
      tools_mode: minimal
      run_script: |
        rustup target add ${{ matrix.target }}
        cargo check -p platform -p traits -p backend --target ${{ matrix.target }} --no-default-features --lib
        cargo check -p platform -p traits -p backend --target ${{ matrix.target }} --no-default-features --features alloc --lib
        cargo build -p platform -p traits -p backend --target ${{ matrix.target }} --no-default-features --lib --release
        cargo build -p platform -p traits -p backend --target ${{ matrix.target }} --no-default-features --features alloc --lib --release

  wasm-pack-optional:
    name: wasm-pack smoke (optional)
    needs: lane-contract
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Setup
        uses: ./.github/actions/setup
        with:
          cache-key: full-main-wasm-pack
          tools-mode: minimal

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: wasm-pack build
        run: wasm-pack build crates/rscrypto --target web --no-default-features --features alloc

  complete:
    name: Complete (full-main)
    needs: [ci, no-std, wasm]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Assert required lanes
        run: |
          if [ "${{ needs.ci.result }}" != "success" ]; then
            exit 1
          fi
          if [ "${{ needs.no-std.result }}" != "success" ]; then
            exit 1
          fi
          if [ "${{ needs.wasm.result }}" != "success" ]; then
            exit 1
          fi
